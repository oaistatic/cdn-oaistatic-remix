import{c as D,r as x,j as e,M as k}from"./lklglvrzltpv3f05.js";import{f as P,en as q,h as N,M as A,y as H,N as Q}from"./ltrr4mhf6s4m7a72.js";import{c1 as V,c0 as W,gi as F,gj as z,gk as U,gl as K,gm as X,A as O,gn as $,go as J,b$ as Y,bv as Z,bG as ee,gg as T}from"./ntw4l0fkgqdiln85.js";import{T as se,I as te}from"./f0ldvca0aj4bxibi.js";const ae=["Not relevant","Inaccurate","Incomplete","Missing sources","I don't like it","Shouldn't have searched Google Drive","Prompt was misunderstood","Didn't like the response style","Other"],ne=["Good sources","Answered my question","I like it","Other"],re=["Not relevant","Out of date","Content is wrong"],oe=["Relevant","Up to date","Accurate"];function le(n){switch(n){case"Not relevant":return u.tagNotRelevant;case"Inaccurate":return u.tagInaccurate;case"Incomplete":return u.tagIncomplete;case"Missing sources":return u.tagMissingSources;case"I don't like it":return u.tagDontLikeIt;case"Shouldn't have searched Google Drive":return u.tagShouldntHaveSearched;case"Prompt was misunderstood":return u.tagPromptMisunderstood;case"Didn't like the response style":return u.tagDidntLikeResponseStyle;case"Other":return u.tagOther;case"Good sources":return u.tagGoodSources;case"Answered my question":return u.tagAnsweredMyQuestion;case"I like it":return u.tagLike;case"Out of date":return u.tagOutOfDate;case"Content is wrong":return u.tagContentWrong;case"Relevant":return u.tagRelevant;case"Up to date":return u.tagUpToDate;case"Accurate":return u.tagAccurate}}function R(n,d){let r;try{r=le(n)}catch{}return r?d.formatMessage(r):n}function E(n,d){return n.map(r=>({label:R(r,d),value:r}))}const u=P({tagNotRelevant:{id:"T24lap",defaultMessage:"Not relevant"},tagInaccurate:{id:"USOv/g",defaultMessage:"Inaccurate"},tagIncomplete:{id:"Lk26Q8",defaultMessage:"Incomplete"},tagMissingSources:{id:"Fng4pl",defaultMessage:"Missing sources"},tagDontLikeIt:{id:"6eAB3A",defaultMessage:"I don't like it"},tagShouldntHaveSearched:{id:"Y22bKM",defaultMessage:"Shouldn't have searched Google Drive"},tagPromptMisunderstood:{id:"NjmgTt",defaultMessage:"Prompt was misunderstood"},tagDidntLikeResponseStyle:{id:"np+P/8",defaultMessage:"Didn't like the response style"},tagOther:{id:"BK4DWm",defaultMessage:"Other"},tagGoodSources:{id:"SpXc0X",defaultMessage:"Good sources"},tagAnsweredMyQuestion:{id:"jbur49",defaultMessage:"Answered my question"},tagLike:{id:"w9iwLl",defaultMessage:"I like it"},tagOutOfDate:{id:"qzHvzr",defaultMessage:"Out of date"},tagContentWrong:{id:"gGDbwI",defaultMessage:"Content is wrong"},tagRelevant:{id:"G4D31U",defaultMessage:"Relevant"},tagUpToDate:{id:"CsRBPs",defaultMessage:"Up to date"},tagAccurate:{id:"ohD9UA",defaultMessage:"Accurate"}});function ie({citationMetadata:n,noBottomBorder:d=!1,sourceFeedback:r,setSourceFeedback:_}){const p=D(),[c,b]=x.useMemo(()=>{if(n.type!=="file")return["",""];const a=n.name.split(".");return a.length>1?[a.slice(0,-1).join("."),a[a.length-1]]:[n.name,""]},[n]),s=x.useMemo(()=>{if(n.type!=="file")return()=>null;const a=n.cloud_doc_url??n.extra?.cloud_doc_url;return a?W(a)?.Icon??(()=>null):V},[n]),m=x.useMemo(()=>{if(n.type==="file"&&n.extra?.cloud_doc_url)try{return new URL(n.extra.cloud_doc_url).hostname}catch{return}},[n]),f=x.useCallback(a=>{_({rating:a,tags:[]})},[_]);return n.type!=="file"?null:e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex flex-row items-center justify-between py-2",children:[e.jsxs("div",{className:"max-width-full mr-2 flex grow flex-row items-center overflow-hidden",children:[e.jsx(s,{className:"icon-md mr-2 flex-shrink-0 flex-grow-0"}),e.jsx("a",{href:n.extra?.cloud_doc_url,className:"text-token-primary flex-grow-1 flex-shrink-1 overflow-hidden text-ellipsis whitespace-nowrap text-sm",target:"_blank",rel:"noreferrer",children:c}),m&&e.jsx("div",{className:"ml-2 text-sm text-token-text-secondary",children:m})]}),e.jsxs("div",{className:"flex shrink-0 flex-row items-center",children:[e.jsx("button",{className:"rounded-md p-1 hover:bg-token-main-surface-secondary",children:r?.rating==="thumbsUp"?e.jsx(F,{className:"icon-md-heavy text-token-text-primary",onClick:()=>f(void 0)}):e.jsx(z,{className:"icon-md-heavy text-token-text-secondary",onClick:()=>f("thumbsUp")})}),e.jsx("button",{className:"rounded-md p-1 hover:bg-token-main-surface-secondary",children:r?.rating==="thumbsDown"?e.jsx(U,{className:"icon-md-heavy text-token-text-primary",onClick:()=>f(void 0)}):e.jsx(K,{className:"icon-md-heavy text-token-text-secondary",onClick:()=>f("thumbsDown")})})]})]}),r?.rating&&e.jsx("div",{className:"mb-4 flex flex-row",children:(r.rating==="thumbsDown"?re:oe).map(a=>e.jsx(se,{className:"mr-2",$selected:r.tags.includes(a),onClick:()=>_({...r,tags:r.tags.includes(a)?r.tags.filter(g=>g!==a):[...r.tags,a]}),children:R(a,p)},a))}),!d&&e.jsx("div",{className:"w-full border-[0.5px] border-token-border-light"})]})}function ce({documentId:n,title:d,externalUrl:r,noBottomBorder:_=!1,shouldHaveBeenIncluded:p,setShouldHaveBeenIncluded:c}){const[b,s]=x.useMemo(()=>{const a=d.split(".");return a.length>1?[a.slice(0,-1).join("."),a[a.length-1]]:[d,""]},[d]),m=x.useMemo(()=>X(q.GDRIVE,s),[s]),f=x.useMemo(()=>{if(r)try{return new URL(r).hostname}catch{return}},[r]);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex flex-row items-center justify-between py-2",children:[e.jsxs("div",{className:"max-width-full mr-2 flex grow flex-row items-center overflow-hidden",children:[e.jsx(m,{className:"mr-2 flex-shrink-0 flex-grow-0"}),e.jsx("a",{href:r,className:"text-token-primary flex-grow-1 flex-shrink-1 overflow-hidden text-ellipsis whitespace-nowrap text-sm",target:"_blank",rel:"noreferrer",children:b}),f&&e.jsx("div",{className:"ml-2 text-sm text-token-text-secondary",children:f})]}),e.jsx("div",{className:"flex shrink-0 flex-row items-center px-2",children:e.jsx(O,{checked:p,onChange:a=>c?.(a.currentTarget.checked),id:`should-have-been-included-${n}`})})]}),!_&&e.jsx("div",{className:"w-full border-[0.5px] border-token-border-light"})]})}function de(n,d){const{entireConversation:r,messageId:_}=d;if(!r)throw new Error("The extraction function only supports exporting the entire conversation for now.");let p=_;const c=[];for(;p;){const b=n.getNodeByIdOrMessageId(p);if(!b){p=null;break}const s=b.message;if(!s)continue;const m=$(s)??"",f=Array.isArray(s.metadata?.citations)?s.metadata.citations:[],a=Array.isArray(s.metadata?.attachments)?s.metadata.attachments:[],g={id:String(s.id),author:s.author.role,recipient:s.recipient??"",createTime:s.create_time,updateTime:s.update_time};switch(s.author.role){case N.System:c.push({...g,type:"system",content:s.content,citations:f,attachments:a});break;case N.Assistant:if(s.recipient&&["user","all"].includes(s.recipient)&&m)c.push({...g,type:"visible_text",text:m,citations:f,attachments:a});else if(s.recipient&&s.recipient.includes("file_search")){const h=s.metadata?.command??"";let M=[];try{const y=JSON.parse(m);typeof y=="object"&&y!=null&&Array.isArray(y.queries)&&(M=y.queries.map(j=>String(j)))}catch{}M?c.push({...g,type:"query",command:h,content:s.content,queries:M}):c.push({...g,type:"generic_file_search_tool",command:h,content:s.content})}break;case N.User:(m||a.length>0)&&c.push({...g,type:"visible_text",text:m,citations:f,attachments:a});break;case N.Tool:if(s.author.name?.includes("file_search")&&s.recipient==="all"){const h=s.metadata?.command??"";if(h==="msearch"&&s.content.content_type===A.TetherBrowsingDisplay){const M=s.content.result;if(M){let y=null;const j=s.metadata?.raw_response;if(typeof j=="object"&&j!=null)try{y=J(j)}catch{}c.push({...g,type:"result",command:h,content:s.content,result:Y(M),searchResponse:y})}}else h==="context_stuff"&&s.content.content_type===A.TetherQuote?c.push({...g,type:"fetch",command:h,content:s.content}):c.push({...g,type:"generic_file_search_tool",command:h,content:s.content})}break}p=b.parentId||null}return d.orderRootToLeaf&&c.reverse(),{messages:c}}const ue="considered-source-should-have-been-used";function xe({citations:n,rating:d,onSubmit:r,onCancel:_,messageId:p,conversationId:c,nodeId:b,conversationTree:s}){const m=D(),f=H(),[a,g]=x.useState(""),[h,M]=x.useState(()=>{const t={};for(const l of n)l.metadata?.type==="file"&&(t[l.metadata.id]={rating:void 0,tags:[],url:l.metadata.extra?.cloud_doc_url});return t}),y=s?.getMessage(p),j=x.useMemo(()=>{const t=new Set,l=[];for(const i of y?.metadata?.citations??[])!i.metadata||i.metadata.type!=="file"||t.has(i.metadata.id)||(l.push(i.metadata),t.add(i.metadata.id));for(const i of y?.metadata?.content_references??[])if(i.type==="file_navlist")for(const o of i.items)t.has(o.id)||(l.push({type:"file",id:o.id,name:o.name,source:"my_files",text:o.description,cloud_doc_url:o.cloud_doc_url,extra:{cloud_doc_url:o.cloud_doc_url}}),t.add(o.id));return l},[y]),[C,G]=x.useState(!0),w=x.useMemo(()=>{const t={hasQuery:!1,lastAssistantMessage:null,lastUserMessage:null,referencedSyncedFiles:[]};if(!s||!b||!s.containsNodeOrMessageId(b))return t;const l=de(s,{messageId:b,entireConversation:!0});for(const i of l.messages)switch(i.type){case"fetch":case"generic_file_search_tool":case"system":continue;case"result":{i.result.chunks.forEach(o=>{o.documentId&&o.documentId.startsWith("S")&&!t.referencedSyncedFiles.some(v=>v.fileId===o.documentId)&&!j.some(v=>v.type==="file"&&v.id===o.documentId)&&t.referencedSyncedFiles.push({fileId:o.documentId,title:o.title})});continue}case"query":{t.hasQuery=!0;continue}case"visible_text":{if(i.author===N.User){if(!t.lastUserMessage){const o=s.getConversationTurns(i.id),v=o[o.length-1].messages,S=v[v.length-1];t.lastUserMessage=S}}else if(i.author===N.Assistant&&!t.lastAssistantMessage){const o=s.getConversationTurns(i.id),v=o[o.length-1].messages,S=v[v.length-1];t.lastAssistantMessage=S,t.lastUserMessage=null}continue}}return t},[s,j,b]),L=x.useCallback(async t=>{const l={...t,additionalSources:a,sourcesFeedback:h,consentedToShareConvoLink:C};Q.submitCaMessageFeedback({feedback_format:Z.ALPHA,message_id:p,conversation_id:c,text:l.textFeedback,rating:d,tags:l.tags,tag_choices:l.tagChoices,additional_sources:l.additionalSources,sources_feedback:l.sourcesFeedback,consented_to_share_convo_link:l.consentedToShareConvoLink}),f.success("Thanks for providing feedback!"),r?.(l)},[a,h,C,p,c,d,f,r]);return e.jsxs(te,{multiple:!0,allowEmptySubmit:!0,onSubmit:L,onCancel:_,tagOptions:E(d==="thumbsDown"?ae:ne,m),modalOnly:!0,modalTitle:e.jsxs("div",{className:"flex items-center gap-2",children:[d==="thumbsDown"?e.jsx(U,{className:"mb-[-6px]"}):e.jsx(F,{className:"mb-[-6px]"}),e.jsx(k,{id:"h5nasL",defaultMessage:"Provide feedback"})]}),children:[j.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("h3",{className:"mt-6 text-base font-semibold",children:e.jsx(k,{id:"G6+7UX",defaultMessage:"Sources"})}),e.jsx("div",{children:j.map((t,l)=>t?.type!=="file"?null:e.jsx(ie,{citationMetadata:t,noBottomBorder:l===j.length-1,sourceFeedback:h[t.id],setSourceFeedback:i=>M(o=>({...o,[t.id]:{...i,url:t.extra?.cloud_doc_url}}))},t.id))})]}),w.referencedSyncedFiles.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mt-6 flex items-baseline justify-between",children:[e.jsxs("div",{className:"flex-start flex",children:[e.jsx("h3",{className:"text-base font-semibold",children:e.jsx(k,{id:"xvBe/T",defaultMessage:"Considered Sources"})}),e.jsx("p",{className:"ml-2 text-token-text-secondary",children:e.jsx(k,{id:"nX81fN",defaultMessage:"({numSources} sources)",values:{numSources:w.referencedSyncedFiles.length}})})]}),e.jsx("p",{className:"text-sm text-token-text-tertiary",children:e.jsx(k,{id:"0+Uivl",defaultMessage:"Good Source?"})})]}),e.jsx("div",{className:"mt-2 max-h-[200px] overflow-auto",children:w.referencedSyncedFiles.map((t,l)=>{const i=t.fileId.split("--")[1];if(!i)return null;const o=`https://drive.google.com/file/d/${i}`;return e.jsx(ce,{title:t.title,documentId:t.fileId,externalUrl:o,noBottomBorder:l===w.referencedSyncedFiles.length-1,shouldHaveBeenIncluded:!!h[t.fileId],setShouldHaveBeenIncluded:v=>M(S=>{const I={...Object.fromEntries(Object.entries(S).filter(([B])=>B!==t.fileId))};return v&&(I[t.fileId]={tags:[ue],rating:"thumbsUp",url:o}),I})},t.fileId)})})]}),e.jsxs("div",{className:"mt-6",children:[e.jsx("p",{className:"text-sm text-token-text-primary",children:e.jsx(k,{id:"1ApJVo",defaultMessage:"Add any additional sources"})}),e.jsx(ee,{name:"feedback",className:"mt-2",placeholder:m.formatMessage({id:"CAFeedbackModal.additionalSourcePlaceholder",defaultMessage:"(Optional) Additional sources"}),value:a,onChange:t=>g(t.target.value)})]}),e.jsxs("div",{className:"mt-6",children:[e.jsx("h3",{className:"mb-2 text-base font-semibold",children:e.jsx(k,{id:"9NcQBu",defaultMessage:"Latest Exchange"})}),e.jsx("div",{className:"p-2",children:e.jsxs("div",{className:"mb-4",children:[w.lastUserMessage&&e.jsxs("div",{className:"mb-4",children:[e.jsx("p",{className:"mb-1 pl-4 text-xs text-token-text-secondary",children:e.jsx(k,{id:"QTWrtR",defaultMessage:"Your message"})}),e.jsx("div",{className:"flex justify-start",children:e.jsx("p",{className:"relative max-w-[var(--user-chat-width,70%)] rounded-3xl bg-[#f4f4f4] px-5 py-2.5 dark:bg-token-main-surface-secondary",children:w.lastUserMessage?e.jsx(T,{message:w.lastUserMessage,isCompletionInProgress:!1,clientThreadId:c,isUserTurn:!1,turnIndex:0,isFeedbackEnabled:!1,showEditButton:!1,onEnterEdit:()=>null,onRequestMoreCompletions:()=>null}):null})})]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("p",{className:"mb-1 pl-4 text-xs text-token-text-secondary",children:e.jsx(k,{id:"ZCTm4h",defaultMessage:"ChatGPT's response"})}),e.jsx("div",{className:"relative rounded-lg bg-token-main-surface-secondary p-4 text-sm",children:w.lastAssistantMessage?e.jsx(T,{message:w.lastAssistantMessage,isCompletionInProgress:!1,clientThreadId:c,isUserTurn:!1,turnIndex:1,isFeedbackEnabled:!1,showEditButton:!1,onEnterEdit:()=>null,onRequestMoreCompletions:()=>null}):null})]})]})}),e.jsxs("div",{className:"mt-4",children:[e.jsx("h3",{className:"mt-6 text-base font-semibold",children:e.jsx(k,{id:"c95uEW",defaultMessage:"Full conversation"})}),e.jsx("p",{className:"mb-2 mt-1 text-sm text-token-text-secondary",children:e.jsx(k,{id:"3E3ZSm",defaultMessage:"If previous portions of this conversation are important to understand your feedback, we encourage you to include it."})}),e.jsx(O,{id:"consented-to-share-entire-convo",label:m.formatMessage({id:"5CC8r8",defaultMessage:"Share Entire Conversation"}),checked:C,onChange:t=>{G(t.currentTarget.checked)}})]})]})]})}export{xe as C,ue as a,R as g};
//# sourceMappingURL=dlzuukwspjdpx4u1.js.map
