import{j as e,r as n,c as y,e as X,ad as $,M as z}from"./lklglvrzltpv3f05.js";import{d$ as G,e0 as Z,bx as K,fQ as ee,fR as se,fS as te,fT as ae,d7 as ne,c6 as E,dn as oe,fU as ie,fV as re,fW as ce,fX as le,dX as ue,dY as me,dZ as de,d_ as D,c7 as I,a$ as fe,fY as R}from"./ntw4l0fkgqdiln85.js";import{S as ge}from"./m1w997decqdgni3k.js";import{J as _,a as xe,c as b,S as he,d as pe}from"./n56psomdxg8obhd8.js";import{J as je,S as be}from"./l1x9lopzxo1y9eiz.js";import{ao as M,y as H,gd as B,q as L,l as Ne,D as we}from"./ltrr4mhf6s4m7a72.js";import{g as ve,a as Ee}from"./iuc1m9qjudz4s87e.js";function W({icon:s,children:t,isOpen:a,setIsOpen:o}){return e.jsx(ce,{className:"p-0",alignAgainstAnchor:"start",triggerButton:e.jsx("button",{className:M("flex h-[34px] w-[34px] items-center justify-center rounded-lg hover:bg-token-main-surface-secondary",a&&"bg-token-main-surface-secondary"),children:s}),open:a,onOpenChange:o,children:t})}function v({label:s,icon:t,disabled:a=!1,onClick:o}){return e.jsxs("button",{className:"flex w-full items-center gap-2 rounded p-2 hover:bg-token-main-surface-secondary",disabled:a,onClick:o,children:[e.jsx("div",{className:"flex h-7 w-7 items-center justify-center",children:t}),e.jsx("div",{className:"text-sm",children:s})]})}function O({label:s,enabled:t,onChange:a}){return e.jsxs("div",{className:"flex w-full justify-between",children:[e.jsx("div",{className:"mr-5 text-sm",children:s}),e.jsx("div",{className:"flex items-center",children:e.jsx(le,{enabled:t,label:"",onChange:a})})]})}function Me(){return e.jsx(V,{children:e.jsx(U,{children:e.jsxs("div",{className:"my-2 flex flex-col justify-center",children:[e.jsx("div",{className:"loading-results-shimmer h-2 w-1/2 rounded-full bg-token-main-surface-secondary"}),e.jsx("div",{className:"loading-results-shimmer mt-3 h-2 w-2/5 rounded-full bg-token-main-surface-secondary"})]})})})}function V({children:s}){return e.jsx("div",{className:M("relative inline-block min-w-[360px] max-w-[400px] overflow-hidden rounded-2xl border border-token-border-light shadow-[0_2px_16px_0_rgba(0,0,0,0.04)]"),children:s})}function U({children:s}){return e.jsx("div",{className:"h-full w-full py-4 pl-5 pr-3",children:s})}function Se({automation:s}){return s?e.jsx(Ae,{item:s}):null}function Ae({item:s}){const t=H();n.useEffect(()=>{G.count(Z.JAWBONE,"jawbone_message_attachment.open")},[]);const{id:a,is_enabled:o,email_enabled:h,notifications_enabled:d,title:i}=s,[f,u]=n.useState(!1),r=n.useRef(null);n.useEffect(()=>{if(r.current){const c=r.current.clientHeight,m=parseFloat(getComputedStyle(r.current).lineHeight);u(c>m)}},[i]);const g=s.next_run_times.length===0,[x,p]=n.useState(!1);return e.jsxs(e.Fragment,{children:[e.jsxs(V,{children:[e.jsx("button",{className:"h-full w-full hover:bg-token-main-surface-secondary",onClick:()=>p(!0),children:e.jsx(U,{children:e.jsx("div",{className:M("flex cursor-pointer justify-between",f?"items-start":"items-center"),children:e.jsxs("div",{className:"flex flex-col gap-[2px] pr-24 text-sm",children:[e.jsx("div",{ref:r,className:"line-clamp-2 text-left font-medium",children:i}),e.jsx("div",{className:"text-left text-token-text-secondary",children:e.jsx(_,{initialScheduleComponents:s.schedule_components,nextRunTimes:s.next_run_times,children:e.jsx(je,{item:s})})})]})})})}),e.jsx("div",{className:"absolute right-3 top-1/2 -translate-y-1/2 transform",children:e.jsxs("div",{className:"ml-4 flex",children:[e.jsx(ye,{automation_id:a,email_enabled:h,notifications_enabled:d,isFinished:g}),e.jsx(Je,{automation_id:a,is_enabled:o,item:s,isFinished:g,onEditModalOpen:()=>p(!0)})]})})]}),x&&e.jsx(_,{initialScheduleComponents:s.schedule_components,nextRunTimes:s.next_run_times,children:e.jsx(xe,{item:s,onClose:c=>{c&&t.success(c),p(!1)}})})]})}function ye({automation_id:s,email_enabled:t,notifications_enabled:a,isFinished:o}){const h=y(),d=K(),[i,f]=n.useState(t);n.useEffect(()=>f(t),[t]);const{mutate:u}=ee({automation_id:s}),[r,g]=n.useState(a);n.useEffect(()=>g(a),[a]);const{mutate:x}=se({automation_id:s}),[p,c]=n.useState(!1);return o?null:e.jsx(W,{icon:e.jsx(ge,{className:"icon-md"}),isOpen:p,setIsOpen:c,children:e.jsxs("div",{className:"flex flex-col gap-4 p-4",children:[e.jsx(O,{label:h.formatMessage({id:"kV6nqC",defaultMessage:"Push notifications"}),enabled:r,onChange:m=>{g(m),x(m,{onError:()=>{g(!m)}})}}),d?.email&&e.jsx(O,{label:h.formatMessage(b.messages.notificationsEmail),enabled:i,onChange:m=>{f(m),u(m,{onError:()=>{f(!m)}})}})]})})}function Je({automation_id:s,is_enabled:t,item:a,isFinished:o,onEditModalOpen:h}){const d=y(),i=X(),f=H(),[u,r]=n.useState(t);n.useEffect(()=>r(t),[t]);const{mutate:g,isPending:x}=te({automation_id:s,onError:l=>{f.danger(d.formatMessage(l?b.messages.enableFailure:b.messages.pauseFailure)),r(!l)}}),[p,c]=n.useState(!1),[m,w]=n.useState(!1);return e.jsxs(W,{icon:e.jsx(ae,{className:"icon-md"}),isOpen:m,setIsOpen:w,children:[e.jsxs("div",{className:"m-2",children:[!o&&e.jsxs(e.Fragment,{children:[e.jsx(v,{icon:e.jsx(ne,{className:"icon-md"}),label:d.formatMessage(E.attachmentEdit),onClick:h}),e.jsx(v,{icon:u?e.jsx(he,{className:"icon-md"}):e.jsx(be,{className:"icon-md"}),label:d.formatMessage(u?b.messages.pause:b.messages.resume),onClick:()=>{const l=!u;r(l),g({is_enabled:l}),w(!1)},disabled:x})]}),o&&e.jsx(v,{icon:e.jsx(oe,{className:"icon-md"}),label:d.formatMessage(b.messages.delete),onClick:()=>{c(!0)}})]}),e.jsx("hr",{className:"w-full border-token-border-light"}),e.jsx("div",{className:"m-2",children:e.jsx(v,{icon:e.jsx(ie,{className:"icon-md"}),label:d.formatMessage(E.attachmentViewAll),onClick:()=>{i(re())}})}),p&&e.jsx(pe,{item:a,onClose:()=>c(!1),onConfirm:()=>c(!1)})]})}function Pe({highlightedText:s,shouldShimmer:t,className:a}){return e.jsx($,{children:e.jsx("div",{className:M(t&&"loading-shimmer-pure-text","absolute left-0 top-0 flex h-8 gap-1 overflow-hidden",a),children:e.jsx("span",{children:s})})})}const F="Too many active automations";function He({clientThreadId:s,currentGroupedMessage:t,nextMessage:a,isLastMessage:o,isRequestActive:h}){const d=o||a,i=h&&!a,f=n.useRef(i);n.useEffect(()=>{i&&(f.current=i)},[i]);const u=t,r=n.useMemo(()=>{for(const j of u?.messages||[]){const N=B(j.message.author.name);if(N?.namespace===L.DE1D73E)return N}},[u]),g=Ce(u,i),x=g?.automationId??"",p=g?.updatedAt??"0",c=g?.error,[m,w]=n.useState(!0),l=ue(j=>me.getAutomation(x,j)),J=l?.updated_at??"0";n.useEffect(()=>{const j=x&&!l,N=new Date(J),Y=new Date(p),Q=!!l&&N<Y;(j||Q)&&de.getAutomation(x).then(A=>{D.setAutomation(x,A)}).catch(A=>{A.status===404&&w(!1)})},[l,x,J,p]);const S=u.messages,P=S[S.length-1]?.message?.metadata?.permissions,C=n.useMemo(()=>P?.some(j=>j.type==="notification"&&j.status==="requested"),[P]);n.useEffect(()=>{c===F&&f.current&&D.setMaxBannerClientThreadId(s)},[c,s]),n.useEffect(()=>{I.initIfNeeded()},[]);const T=S[0].message.create_time,k=n.useRef(!1);if(n.useEffect(()=>{(async()=>{if(k.current)return;await ke(l,C,T)&&(k.current=!0,I.setRequestingClientThreadId(s))})()},[l,T,s,C]),!i&&c&&c!==F)return e.jsx(Te,{});if(m&&d){if(x)return e.jsx("div",{className:"mb-3",children:l?e.jsx(Se,{automation:l}):f.current?e.jsx(q,{functionName:r?.functionName}):e.jsx(Me,{})});if(i&&r)return e.jsx(q,{functionName:r.functionName})}return null}function q({functionName:s}){const t=y();return e.jsx("div",{className:"relative h-8 text-token-text-secondary first:mt-0",children:e.jsx(Pe,{highlightedText:t.formatMessage(s==="update"?E.updatingAutomation:E.makingAutomation),className:"mr-1.5 mt-1 items-center justify-start",shouldShimmer:!0})})}function Ce(s,t){return n.useMemo(()=>{if(t)return;const a=s?.messages?.find(o=>B(o.message.author.name)?.namespace===L.DE1D73E);if(a)try{const o=JSON.parse(Ne(a.message));return o.status==="ERROR"?{error:o.message}:{automationId:o.jawbone.id,updatedAt:o.jawbone.updated_at}}catch(o){we.addError("Jawbone: Failed to parse automation message",{cause:o});return}},[s,t])}function Te(){return e.jsxs("div",{className:"flex items-center gap-2 pb-1 text-token-text-error",children:[e.jsx(fe,{className:"icon-sidebar"}),e.jsx("div",{children:e.jsx(z,{id:"oOQhkY",defaultMessage:"Task scheduling wasn’t completed — please ask again."})})]})}async function ke(s,t,a){if(!s||!s.notifications_enabled||!t||!a)return!1;const o=new Date(a*1e3);if(!(Math.abs(new Date().getTime()-o.getTime())<=5*60*1e3))return!1;const i=R.getLastRequestTime();return!(i&&Date.now()-new Date(i).getTime()<24*60*60*1e3||R.getPermission()==="denied"||!await ve()||await Ee())}export{He as JawboneMessage};
//# sourceMappingURL=n6qn9fvtm30vs6ka.js.map
