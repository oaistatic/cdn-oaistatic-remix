import{gi as U,y as E,gj as L,gk as B,eW as S,gl as P,gm as F,f as O,bu as v,N as j}from"./ltrr4mhf6s4m7a72.js";import{eJ as k}from"./ntw4l0fkgqdiln85.js";import{r as p,c as C,v as Q}from"./lklglvrzltpv3f05.js";function y(){if("MediaSource"in window){const a=e=>U(e)&&MediaSource.isTypeSupported(e);if(a("audio/aac"))return"aac";if(a("audio/mpeg"))return"mp3";if(a("audio/ogg"))return"ogg"}}class V{capacity;cache;dispose;constructor({capacity:e,dispose:o}){this.capacity=e,this.cache=new Map,this.dispose=o}get(e){if(!this.cache.has(e))return null;const o=this.cache.get(e);return this.cache.delete(e),this.cache.set(e,o),o}set(e,o){if(this.cache.has(e)){this.cache.delete(e),this.cache.set(e,o);return}if(this.cache.size>=this.capacity){const i=this.cache.keys().next().value;this.delete(i)}this.cache.set(e,o)}delete(e){const o=this.cache.get(e);this.cache.delete(e),this.dispose&&this.dispose(o)}}function W({conversationId:a,messageId:e}){const{voiceName:o}=k(),i=()=>j.synthesize({message_id:e,conversation_id:a,voice:o,format:y()}),s=`${a}.${e}.${o}`;return x(i,s)}function x(a,e){const[o,i]=p.useState(!1),s=p.useRef({isMediaSourceAvailable:A(),mediaSourceFormat:y()??"n/a",playPromise:null,shouldAbortQueuedPlayback:!1}).current,t=C(),d=E(),f=L(),c=B(r=>r.isPlaying&&r.sourceUrl===u.get(e)?.src),n=p.useCallback(async()=>{if(!f)return;i(!0);const r={isMediaSourceAvailable:s.isMediaSourceAvailable,format:s.mediaSourceFormat};try{const m=await $({key:e,onStreamingError:b=>{S.readAloud.error(b,r),i(!1),d.danger(t.formatMessage(w.playbackError,{error:b.message}))},onStreamingStart:()=>{i(!1)},fetchAudioDataResponse:a});if(s.shouldAbortQueuedPlayback){s.shouldAbortQueuedPlayback=!1;return}f.changeSource(m),s.playPromise=f.play()}catch(m){S.readAloud.error(m,r),i(!1),d.danger(t.formatMessage(w.playbackError,{error:m.message}))}},[f,s,e,d,t,a]),h=p.useCallback(()=>{const r=P();r&&(s.playPromise?s.playPromise.then(()=>{r.stop(),s.playPromise=null}):r.stop())},[s]),l=p.useCallback(()=>{const r=P();r&&(r.state.isPlaying&&r.state.sourceUrl===u.get(e)?.src?h():(S.readAloud.click({isMediaSourceAvailable:s.isMediaSourceAvailable,format:s.mediaSourceFormat}),n()))},[e,s,n,h]);p.useEffect(()=>{o&&c&&i(!1)},[o,c]);const g=p.useRef(e);return p.useEffect(()=>{g.current=e}),p.useEffect(()=>(s.shouldAbortQueuedPlayback=!1,()=>{const r=F();r.isPlaying&&r.sourceUrl===u.get(g.current)?.src?h():s.shouldAbortQueuedPlayback=!0}),[s,h]),{togglePlayback:l,isPlaying:c,isLoading:o}}async function M(a){const e=await a(),o=e.headers.get("content-type")??"audio/aac";return{response:e,format:o}}async function $(a){return A()?N(a):z(a)}async function z({key:a,fetchAudioDataResponse:e}){const o=u.get(a);if(o?.blob)return o.src;const{response:i,format:s}=await M(e),t=await i.arrayBuffer(),d=new Blob([t],{type:s}),f=R({key:a,src:URL.createObjectURL(d),format:s,blob:d});return u.set(a,f),f.src}async function N({key:a,onStreamingError:e,onStreamingStart:o,fetchAudioDataResponse:i}){let s=u.get(a);s?.streaming&&(u.delete(a),s=null);let t,d;const f=_(),c=new f;if(s)t=s,t.src=URL.createObjectURL(c);else{const{format:l,response:g}=await M(i);d=g,t=R({key:a,src:URL.createObjectURL(c),format:l})}const n=T(t.id),h={sourceopen:async()=>{n("sourceopen");const l=c.addSourceBuffer(t.format),g=async()=>{l.updating&&await new Promise(r=>l.addEventListener("updateend",r,{once:!0}))};if(t.segments.length&&!t.streaming){n("streaming from cache"),t.streaming=!0,o();for(const r of t.segments)l.appendBuffer(r),await g();c.readyState==="open"&&c.endOfStream(),t.streaming=!1,n("done streaming from cache");return}if(d){n("fetching audio");try{const r=d.body?.getReader();if(!r)return;for(;u.get(a)?.id===t.id;){const{done:m,value:b}=await r.read();if(m){n("done streaming"),t.streaming=!1,c.readyState==="open"&&c.endOfStream();break}if(!Array.from(c.sourceBuffers).includes(l)){n("stop streaming, source buffer removed"),t.streaming=!1;break}t.streaming||(n("start streaming"),t.streaming=!0,o()),l.appendBuffer(b),t.segments.push(b),await g()}}catch(r){if(n("error while streaming",r),t.streaming=!1,c.readyState==="open")try{c.endOfStream("network")}catch(m){S.readAloud.error(m)}u.delete(a),e(r)}}},sourceclose:()=>{n("sourceclose"),t.streaming&&(t.streaming=!1,u.get(a)?.id===t.id&&(n("sourceclosed while streaming, cleaning up cache"),u.delete(a)))},sourceended:v};for(const[l,g]of Object.entries(h))c.addEventListener(l,()=>{try{return g()}catch(r){S.readAloud.error(r)}});return u.set(a,t),t.src}const w=O({playbackError:{id:"useVoiceReadAloudAudio.playbackError",defaultMessage:"Failed to play message"}}),T=a=>v;function _(){return A()?window.MediaSource:null}function A(){return!!y()}const R=a=>({id:Q(),segments:[],streaming:!1,...a}),u=new V({capacity:50,dispose:a=>{URL.revokeObjectURL(a.src)}});export{x as a,y as g,W as u};
//# sourceMappingURL=n6v4rknj9zgtveaq.js.map
