import{r as k,V as mr,v as gr,j as g,c as ft,ax as At,ay as Mr,aB as It,aw as wr,at as Ot,ac as xe,ad as je,M as Nr}from"./lklglvrzltpv3f05.js";import{$ as ht,Q as kr,S as xr,a0 as Dt,E as yr,C as Cr,J as Er,A as br,y as vr,a1 as Tr,z as Sr,M as Pr,R as Rr,a2 as mt,a3 as q,a4 as Nn,a5 as Ar,a6 as Ir,a7 as Or,a8 as kn,a9 as xn,aa as Dr,ab as _r,ac as Ve,ad as qe,ae as ze,w as Br,af as yn,ag as Lr,ah as Cn,ai as Vr,aj as Hr,U as jr,V as zr,ak as Ne,W as _t,X as Fr,Y as $r,Z as Ur,_ as Bt}from"./m0k8fep4xbmrbvdx.js";import{al as Ce,o as Lt,d as Vt,E as Ht,m as Wr,am as Kr,a8 as W,an as Ke,ao as Gr,ap as Xr,ab as Yr,aq as Zr,ar as qr,as as Jr,ad as gt,a9 as Qr,ae as En,at as eo,au as to,av as no,aw as ro,a3 as bn,H as De,I as oo,ax as so}from"./cjqhn7fwy4oztky3.js";import{w as te,p as ee,T as Z,z as ye,D as Y,A as io,B as ao,F as vn,S as Mt,G as lo,H as jt,I as co,J as uo,K as Tn,L as po,O as ot,Q as st,q as fo,V as F,W as Se,X as Pe,Y as Sn,Z as ho,r as mo,_ as wt,$ as go,a0 as Nt,a1 as Mo,v as wo,a2 as Pn,a3 as No,a4 as Rn,a5 as ko,a6 as xo,a7 as An,a8 as yo,t as In}from"./hzzlkn5ny7a6v61q.js";import{f as kt,ao as J,hO as be,D as xt,B as Re,o as On,j as le,d8 as Co,y as Eo,bE as Dn,hP as bo,dZ as _n,b as vo,gx as it,c as To,bp as So,a as Po}from"./ltrr4mhf6s4m7a72.js";import{m as Ro,Z as Bn,k as zt,f as Ao,C as Je,M as Io,n as Oo,o as Ft,i as Do,p as _o}from"./588xx36j2cp3onfx.js";import{pE as $t,lf as Ln,gN as at,t as Ut,pF as Bo,pG as Lo,bf as Vo,dR as B,n1 as Ho,cO as jo,pH as zo,lj as Wt,kI as yt,kJ as Vn,kt as Hn,kK as Ct,g as Fo,dS as de,i8 as $o,i9 as Uo}from"./ntw4l0fkgqdiln85.js";import{f as Kt,a as Wo,p as Ko,h as Go,i as Xo,R as Yo,L as Zo}from"./hk41gcw8y8nzc13q.js";import{d as qo,r as Jo,u as Qo}from"./m5j2h3o7mzg7czxx.js";import{u as es}from"./l6o7kknkh2c8b31f.js";import"./fzrn137102spawew.js";import"./fz325pbgpjkh5w1d.js";import"./k3hicc8rbwef28my.js";import"./m3hzqkul64iyv6kj.js";import"./j9pn3dpqp3dnyeg5.js";import"./cyqh5pewhk34cwzb.js";import"./d197qvlrpr6mqktk.js";import"./vyarha3ckzwu9yf1.js";import"./lnovrxcizvfadwta.js";import"./n6v4rknj9zgtveaq.js";import"./lr2wtvbk3k0uolp8.js";import"./b7a3ebwp9zr2v92r.js";import"./bwsmtgh34vk8igjb.js";import"./ccbvqxrwvcpykpsk.js";import"./i319krasmy4ol4lq.js";import"./bygcqg9ufhsq2txx.js";import"./kqwdyvkaaavvn8k3.js";import"./abdi060vkh3h3l2t.js";var Gt={}.hasOwnProperty;function ts(n,e){var t=e||{};function r(o){var s=r.invalid,i=r.handlers;if(o&&Gt.call(o,n)&&(s=Gt.call(i,o[n])?i[o[n]]:r.unknown),s)return s.apply(this,arguments)}return r.handlers=t.handlers||{},r.invalid=t.invalid,r.unknown=t.unknown,r}const ns={}.hasOwnProperty;function jn(n,e){let t=-1,r;if(e.extensions)for(;++t<e.extensions.length;)jn(n,e.extensions[t]);for(r in e)if(ns.call(e,r))switch(r){case"extensions":break;case"unsafe":{Xt(n[r],e[r]);break}case"join":{Xt(n[r],e[r]);break}case"handlers":{rs(n[r],e[r]);break}default:n.options[r]=e[r]}return n}function Xt(n,e){e&&n.push(...e)}function rs(n,e){e&&Object.assign(n,e)}const os=[ss];function ss(n,e,t,r){if(e.type==="code"&&Kt(e,r)&&(n.type==="list"||n.type===e.type&&Kt(n,r)))return!1;if("spread"in t&&typeof t.spread=="boolean")return n.type==="paragraph"&&(n.type===e.type||e.type==="definition"||e.type==="heading"&&Wo(e,r))?void 0:t.spread?1:0}const pe=["autolink","destinationLiteral","destinationRaw","reference","titleQuote","titleApostrophe"],is=[{character:"	",after:"[\\r\\n]",inConstruct:"phrasing"},{character:"	",before:"[\\r\\n]",inConstruct:"phrasing"},{character:"	",inConstruct:["codeFencedLangGraveAccent","codeFencedLangTilde"]},{character:"\r",inConstruct:["codeFencedLangGraveAccent","codeFencedLangTilde","codeFencedMetaGraveAccent","codeFencedMetaTilde","destinationLiteral","headingAtx"]},{character:`
`,inConstruct:["codeFencedLangGraveAccent","codeFencedLangTilde","codeFencedMetaGraveAccent","codeFencedMetaTilde","destinationLiteral","headingAtx"]},{character:" ",after:"[\\r\\n]",inConstruct:"phrasing"},{character:" ",before:"[\\r\\n]",inConstruct:"phrasing"},{character:" ",inConstruct:["codeFencedLangGraveAccent","codeFencedLangTilde"]},{character:"!",after:"\\[",inConstruct:"phrasing",notInConstruct:pe},{character:'"',inConstruct:"titleQuote"},{atBreak:!0,character:"#"},{character:"#",inConstruct:"headingAtx",after:`(?:[\r
]|$)`},{character:"&",after:"[#A-Za-z]",inConstruct:"phrasing"},{character:"'",inConstruct:"titleApostrophe"},{character:"(",inConstruct:"destinationRaw"},{before:"\\]",character:"(",inConstruct:"phrasing",notInConstruct:pe},{atBreak:!0,before:"\\d+",character:")"},{character:")",inConstruct:"destinationRaw"},{atBreak:!0,character:"*",after:`(?:[ 	\r
*])`},{character:"*",inConstruct:"phrasing",notInConstruct:pe},{atBreak:!0,character:"+",after:`(?:[ 	\r
])`},{atBreak:!0,character:"-",after:`(?:[ 	\r
-])`},{atBreak:!0,before:"\\d+",character:".",after:`(?:[ 	\r
]|$)`},{atBreak:!0,character:"<",after:"[!/?A-Za-z]"},{character:"<",after:"[!/?A-Za-z]",inConstruct:"phrasing",notInConstruct:pe},{character:"<",inConstruct:"destinationLiteral"},{atBreak:!0,character:"="},{atBreak:!0,character:">"},{character:">",inConstruct:"destinationLiteral"},{atBreak:!0,character:"["},{character:"[",inConstruct:"phrasing",notInConstruct:pe},{character:"[",inConstruct:["label","reference"]},{character:"\\",after:"[\\r\\n]",inConstruct:"phrasing"},{character:"]",inConstruct:["label","reference"]},{atBreak:!0,character:"_"},{character:"_",inConstruct:"phrasing",notInConstruct:pe},{atBreak:!0,character:"`"},{character:"`",inConstruct:["codeFencedLangGraveAccent","codeFencedMetaGraveAccent"]},{character:"`",inConstruct:"phrasing",notInConstruct:pe},{atBreak:!0,character:"~"}];function as(n){return n.label||!n.identifier?n.label||"":qo(n.identifier)}function ls(n){if(!n._compiled){const e=(n.atBreak?"[\\r\\n][\\t ]*":"")+(n.before?"(?:"+n.before+")":"");n._compiled=new RegExp((e?"("+e+")":"")+(/[|\\{}()[\]^$+*?.-]/.test(n.character)?"\\":"")+n.character+(n.after?"(?:"+n.after+")":""),"g")}return n._compiled}function cs(n,e,t){const r=e.indexStack,o=n.children||[],s=[];let i=-1,a=t.before;r.push(-1);let l=e.createTracker(t);for(;++i<o.length;){const u=o[i];let c;if(r[r.length-1]=i,i+1<o.length){let d=e.handle.handlers[o[i+1].type];d&&d.peek&&(d=d.peek),c=d?d(o[i+1],n,e,{before:"",after:"",...l.current()}).charAt(0):""}else c=t.after;s.length>0&&(a==="\r"||a===`
`)&&u.type==="html"&&(s[s.length-1]=s[s.length-1].replace(/(\r?\n|\r)$/," "),a=" ",l=e.createTracker(t),l.move(s.join(""))),s.push(l.move(e.handle(u,n,e,{...l.current(),before:a,after:c}))),a=s[s.length-1].slice(-1)}return r.pop(),s.join("")}function us(n,e,t){const r=e.indexStack,o=n.children||[],s=e.createTracker(t),i=[];let a=-1;for(r.push(-1);++a<o.length;){const l=o[a];r[r.length-1]=a,i.push(s.move(e.handle(l,n,e,{before:`
`,after:`
`,...s.current()}))),l.type!=="list"&&(e.bulletLastUsed=void 0),a<o.length-1&&i.push(s.move(ds(l,o[a+1],n,e)))}return r.pop(),i.join("")}function ds(n,e,t,r){let o=r.join.length;for(;o--;){const s=r.join[o](n,e,t,r);if(s===!0||s===1)break;if(typeof s=="number")return`
`.repeat(1+s);if(s===!1)return`

<!---->

`}return`

`}const ps=/\r?\n|\r/g;function fs(n,e){const t=[];let r=0,o=0,s;for(;s=ps.exec(n);)i(n.slice(r,s.index)),t.push(s[0]),r=s.index+s[0].length,o++;return i(n.slice(r)),t.join("");function i(a){t.push(e(a,o,!a))}}function hs(n,e,t){const r=(t.before||"")+(e||"")+(t.after||""),o=[],s=[],i={};let a=-1;for(;++a<n.unsafe.length;){const c=n.unsafe[a];if(!Ko(n.stack,c))continue;const d=n.compilePattern(c);let f;for(;f=d.exec(r);){const h="before"in c||!!c.atBreak,p="after"in c,m=f.index+(h?f[1].length:0);o.includes(m)?(i[m].before&&!h&&(i[m].before=!1),i[m].after&&!p&&(i[m].after=!1)):(o.push(m),i[m]={before:h,after:p})}}o.sort(ms);let l=t.before?t.before.length:0;const u=r.length-(t.after?t.after.length:0);for(a=-1;++a<o.length;){const c=o[a];c<l||c>=u||c+1<u&&o[a+1]===c+1&&i[c].after&&!i[c+1].before&&!i[c+1].after||o[a-1]===c-1&&i[c].before&&!i[c-1].before&&!i[c-1].after||(l!==c&&s.push(Yt(r.slice(l,c),"\\")),l=c,/[!-/:-@[-`{-~]/.test(r.charAt(c))&&(!t.encode||!t.encode.includes(r.charAt(c)))?s.push("\\"):(s.push("&#x"+r.charCodeAt(c).toString(16).toUpperCase()+";"),l++))}return s.push(Yt(r.slice(l,u),t.after)),s.join("")}function ms(n,e){return n-e}function Yt(n,e){const t=/\\(?=[!-/:-@[-`{-~])/g,r=[],o=[],s=n+e;let i=-1,a=0,l;for(;l=t.exec(s);)r.push(l.index);for(;++i<r.length;)a!==r[i]&&o.push(n.slice(a,r[i])),o.push("\\"),a=r[i];return o.push(n.slice(a)),o.join("")}function gs(n){const e=n||{},t=e.now||{};let r=e.lineShift||0,o=t.line||1,s=t.column||1;return{move:l,current:i,shift:a};function i(){return{now:{line:o,column:s},lineShift:r}}function a(u){r+=u}function l(u){const c=u||"",d=c.split(/\r?\n|\r/g),f=d[d.length-1];return o+=d.length-1,s=d.length===1?s+f.length:1+f.length+r,c}}function Ms(n,e={}){const t={enter:o,indentLines:fs,associationId:as,containerPhrasing:xs,containerFlow:ys,createTracker:gs,compilePattern:ls,safe:Cs,stack:[],unsafe:[...is],join:[...os],handlers:{...Go},options:{},indexStack:[],handle:void 0};jn(t,e),t.options.tightDefinitions&&t.join.push(ks),t.handle=ts("type",{invalid:ws,unknown:Ns,handlers:t.handlers});let r=t.handle(n,void 0,t,{before:`
`,after:`
`,now:{line:1,column:1},lineShift:0});return r&&r.charCodeAt(r.length-1)!==10&&r.charCodeAt(r.length-1)!==13&&(r+=`
`),r;function o(s){return t.stack.push(s),i;function i(){t.stack.pop()}}}function ws(n){throw new Error("Cannot handle value `"+n+"`, expected node")}function Ns(n){const e=n;throw new Error("Cannot handle unknown node `"+e.type+"`")}function ks(n,e){if(n.type==="definition"&&n.type===e.type)return 0}function xs(n,e){return cs(n,this,e)}function ys(n,e){return us(n,this,e)}function Cs(n,e){return hs(this,n,e)}class zn extends Ce{unistNodeName(){return"link"}static proseMirrorMarkName(){return"link"}proseMirrorMarkSpec(){return{attrs:{href:{},title:{default:null},disabled:{default:!0}},inclusive:!1,parseDOM:[{tag:"a[href]",getAttrs(e){return{href:e.getAttribute("href"),title:e.getAttribute("title")}}}],toDOM(e){return["a",{...e.attrs,...e.attrs.disabled?{href:void 0}:{}}]}}}unistNodeToProseMirrorNodes({node:e,convertedChildren:t,schema:r}){const{url:o,title:s}=e;return t.map(i=>i.mark(i.marks.concat([r.marks[this.proseMirrorMarkName()].create({href:o,title:s})])))}processConvertedUnistNode(e,t){return{type:this.unistNodeName(),url:t.attrs.href,...t.attrs.title!=null&&{title:t.attrs.title},children:[e]}}}function Es(n,e){const t=[];return n.descendants((r,o)=>{r.marks.forEach(s=>{s.type===e&&t.push({from:o,to:o+r.nodeSize,mark:s})})}),t}function bs(n,e,t){const r=e.mark.type,o={...e.mark.attrs,disabled:t};return n.removeMark(e.from,e.to,r),n.addMark(e.from,e.to,r.create(o)),n}const Et=new te("disableUnsafeLinks");function vs(n,e){return n.setMeta(Et,{safeUrls:e})}function Ts(n){return n.getMeta(Et)??null}function Ss(n=new Set){return new ee({key:Et,state:{init(e){return{safeUrls:n}},apply(e,t){const r=Ts(e);if(r==null)return t;const{safeUrls:o}=r;return{...t,safeUrls:o}}},appendTransaction(e,t,r){const o=this.getState(r),s=r.tr,i=r.schema.marks[zn.proseMirrorMarkName()],a=Es(r.doc,i);let l=!1;return a.forEach(u=>{const c=u.mark.attrs.href,d=o.safeUrls.has(c),f=u.mark.attrs.disabled===!0;d===f&&(bs(s,u,!d),l=!0)}),l?s:null}})}const Fe=new te("placeholder");function Ps(n,e){return n.setMeta(Fe,{isDisabled:e})}function Rs(n){return n.getMeta(Fe)??null}function As(n,e=!1){return new ee({key:Fe,state:{init(){return{isDisabled:e}},apply(t,r){const o=Rs(t);return o?.isDisabled!=null?{...r,isDisabled:o.isDisabled}:r}},props:{decorations(t){const{doc:r,selection:o}=t;if(Fe.getState(t).isDisabled||!(o instanceof Z&&o.empty))return null;const{$cursor:i}=o;if(!i||!n)return null;const a=i.start();if(!((i.parent.isTextblock||i.parent.type.name==="doc")&&i.pos===a&&i.node().content.size===0))return null;const u=ye.widget(a,()=>{const c=document.createTextNode(n.formatMessage(Is.placeholder)),d=document.createElement("span");return d.className="text-token-text-tertiary dark:text-gray-500 pointer-events-none select-none",d.style.position="absolute",d.appendChild(c),d});return Y.create(r,[u])}}})}const Is=kt({placeholder:{id:"n2B51U",defaultMessage:"Write something..."}}),Os={"override-strong-color":"_override-strong-color_y6grp_1"};function Fn({isHovered:n,isRejected:e,isTextAcive:t}){return J({"line-through":!t,"filter grayscale-[0.6]":e&&!t,"opacity-60":e&&!t,"bg-opacity-50 dark:bg-opacity-50":e&&n,"bg-opacity-10 dark:bg-opacity-10":e&&!n,"bg-opacity-60 dark:bg-opacity-60":!e&&!n})}function Ds({isHovered:n,isRejected:e,isReplacement:t}){return J("bg-red-100 dark:bg-red-600",Fn({isHovered:n,isRejected:e,isTextAcive:e}),{"dark:bg-red-800":e,"text-red-500 dark:text-red-200":!e,"border border-red-400 rounded-l border-r-0":e&&t,"border border-red-400 rounded":e&&!t})}function _s({isHovered:n,isRejected:e,isReplacement:t}){const r=!e;return J(Os["override-strong-color"],"text-green-600 dark:text-green-200 bg-green-100 dark:bg-green-600",Fn({isHovered:n,isRejected:e,isTextAcive:r}),{"dark:bg-green-800":e,"border border-green-500 rounded-r border-l-0":e&&t,"border border-green-500 rounded":e&&!t})}const lt=new te("edit"),Zt=(n,e,t,r)=>{const o=[];for(const{start:s,end:i,editId:a}of e)o.push(ye.inline(s,i,{class:Ds({isHovered:!1,isRejected:!1,isReplacement:!1}),"data-edit-id":a}));for(const{start:s,end:i,editId:a}of n)o.push(ye.inline(s,i,{class:_s({isHovered:!1,isRejected:!1,isReplacement:!0}),"data-edit-id":a}));return o},Bs=(n,e)=>new ee({key:lt,state:{init(){const r=new Set;return{decorations:Zt(n,e),hoveredEditId:null,rejectedEdits:r}},apply(t,r){const o=t.getMeta(lt)??null,{hoveredEditId:s,rejectedEdits:i}=o??r;return{decorations:Zt(n,e),hoveredEditId:s,rejectedEdits:i}}},props:{decorations(t){const r=this.getState(t);return r?Y.create(t.doc,r.decorations.concat()):Y.empty},editable(){return!1},attributes(){return{class:"cursor-default",style:"--text-primary:var(--text-secondary)"}}}});class oe{constructor(e,t){this.length=e,this.step=t}cut(e){return e===this.length?this:new oe(e,this.step)}static slice(e,t,r){if(t===r)return oe.none;if(t===0&&r===oe.len(e))return e;const o=[];for(let s=0,i=0;i<r;s++){const a=e[s],l=i+a.length,u=Math.min(r,l)-Math.max(t,i);u>0&&o.push(a.cut(u)),i=l}return o}static join(e,t,r){if(e.length===0)return t;if(t.length===0)return e;const o=r(e[e.length-1].step,t[0].step);if(o==null)return e.concat(t);const s=e.slice(0,e.length-1);s.push(new oe(e[e.length-1].length+t[0].length,o));for(const i of t)s.push(i);return s}static len(e){let t=0;for(const r of e)t+=r.length;return t}static none=[]}class Ls{constructor(e,t,r,o,s,i){this.fromA=e,this.toA=t,this.fromB=r,this.toB=o,this.deleted=s,this.inserted=i}get lenA(){return this.toA-this.fromA}get lenB(){return this.toB-this.fromB}}const qt=(n,e,t,r,o)=>new Ls(n,e,t,r,n===e?oe.none:[new oe(e-n,o)],t===r?oe.none:[new oe(r-t,o)]);class $e{constructor(e,t){this.doc=e,this.changes=t}static create(e){return new $e(e,[])}addSteps(e,t){const r=[];for(const s of t){let i=0;if(s.getMap().forEach((a,l,u,c)=>{r.push(qt(a+i,l+i,u,c,s)),i=c-u-(l-a)}),s instanceof io||s instanceof ao){const{from:a,to:l}=s;r.push(qt(a,l,a,l,s))}}if(r.length===0)return this;const o=this.changes.concat(r);return new $e(e,o)}}const Te=new te("changeset"),ct=new te("highlightChanges"),$n=n=>Te.getState(n),Vs=n=>{const{state:e}=n,t=e.tr.setMeta(Te,!0);n.updateState(e.apply(t))},Hs=n=>{const{state:e}=n,t=$n(e);if(!t)return;const{maps:r,steps:o}=t,s=new vn(r),i=e.tr;for(let l=o.length-1;l>=0;l--){const u=o[l].map(s.slice(l+1));if(!u)continue;i.maybeStep(u).doc&&s.appendMap(u.getMap(),l)}const a=e.apply(i.setMeta(Te,!0));n.updateState(a)},js=()=>{const n=r=>({changeset:$e.create(r),maps:[],steps:[]}),e=new ee({key:Te,state:{init:(r,{doc:o})=>n(o),apply:(r,o,s,i)=>{const{doc:a}=i;if(r.getMeta(Te))return n(a);const{docChanged:u,mapping:c,steps:d,docs:f}=r;if(!u)return o;const{changeset:h,maps:p,steps:m}=o,{maps:M}=c,x=d.map((y,N)=>y.invert(f[N]));return{changeset:h.addSteps(a,d),maps:p.concat(M),steps:m.concat(x)}}}}),t=new ee({key:ct,state:{init(){return{deco:Y.empty,show:!1}},apply(r,o,s,i){const a=e.getState(i);if(!a)return o;const{changeset:l}=a,{doc:u}=i,{changes:c}=l,d=c.map(({fromB:h,toB:p})=>ye.inline(h,p,{class:"blame-marker"})),f=r.getMeta(ct);return{deco:Y.create(u,d),show:f??o.show}}},props:{decorations(r){const o=this.getState(r);if(!o?.show)return Y.empty;const{deco:s}=o;return s}}});return[e,t]},fe=(n,e,t)=>{k.useEffect(()=>{const r=e.current;if(!r)return;const{state:o}=r,s=n(o.tr);s&&r.dispatch(s)},t)};var ge=(n=>(n.PROSEMIRROR_CONTEXT_CHILDREN="prosemirror-context-children",n.PROSEMIRROR_EDITOR_CONTAINER="prosemirror-editor-container",n))(ge||{});function zs(n,e){return{x:$t(e.x,n.left,n.right),y:$t(e.y,n.top,n.bottom)}}function Un(n){let e=n.selection.$from.pos-1;if(e<0)return null;let t=n.doc.nodeAt(e);for(;(t==null||t.type.name===ht.proseMirrorNodeName())&&e>0;)e-=1,t=n.doc.nodeAt(e);return t!=null?{node:t,pos:e}:t}function Fs(n,e){const t=Un(n);if(t==null)return!1;const{node:r,pos:o}=t,s=o+r.nodeSize,i=n.tr,l=n.schema.nodes.paragraph.create(null);i.insert(s,l);const u=s+l.nodeSize-1,c=i.doc.resolve(u),d=new Z(c);return i.setSelection(d),e(i),!0}function $s(n,e){const t=Un(n);if(t==null)return!1;const{node:r,pos:o}=t,s=n.tr;return s.deleteRange(o,o+r.nodeSize),e(s),!0}const Jt=(n,e)=>{if(n===e)return null;let t=0,r=n.length,o=e.length;for(;t<r&&n.charCodeAt(t)===e.charCodeAt(t);)t+=1;for(;r>t&&o>t&&n.charCodeAt(r-1)===e.charCodeAt(o-1);)r-=1,o-=1;return{from:t,to:r,text:e.slice(t,o)}},Qt=kr({settings:{background:"var(--gray-100)"}});class bt{constructor(e,t,r,o){this.pmView=t,this.getPos=r,this.node=e;const s=[{key:"ArrowUp",run:this.maybeEscape("line",-1)},{key:"ArrowLeft",run:this.maybeEscape("char",-1)},{key:"ArrowDown",run:this.maybeEscape("line",1)},{key:"ArrowRight",run:this.maybeEscape("char",1)},{key:"Backspace",run:this.handleBackspace},{key:"Shift-Enter",run:this.handleShiftEnter}];this.languageCompartment=new Lt,this.themeCompartment=new Lt;const i=xr(e.attrs.lang),a=Vt.create({doc:this.node.textContent,extensions:[this.themeCompartment.of(o?Dt:Qt),Ht.theme({"&":{borderRadius:"4px",padding:"0.5rem"},"&.cm-focused":{outline:"none"}}),Wr.of([...s,...yr,...Cr,Er]),br(),vr(),Tr(),Kr(),Sr(Pr),this.languageCompartment.of(i!=null?[i]:[]),Vt.changeFilter.of(l=>(!l.docChanged&&!this.updating&&this.forwardSelection(),!0))]});this.cm=new Ht({state:a,dispatch:this.dispatch}),i==null&&this.setLanguage(e.attrs.lang)}node;updating=!1;cm;languageCompartment;themeCompartment;get pmSchema(){return this.pmView.state.schema}get dom(){return this._setIsCodeBlockView(),this.cm.dom}setLanguage=async e=>{const t=await Rr(e);t&&this.cm.dispatch({effects:this.languageCompartment.reconfigure(t)})};setTheme=e=>{const t=e?Dt:Qt;this.cm.dispatch({effects:this.themeCompartment.reconfigure(t)})};handleBackspace=e=>{const{selection:t}=e.state;if(!(t.main.empty&&t.main.from===0)||this.cm.state.doc.length>0)return!1;const r=$s(this.pmView.state,this.pmView.dispatch);return this.pmView.focus(),r};handleShiftEnter=()=>{const e=Fs(this.pmView.state,this.pmView.dispatch);return this.pmView.focus(),e};dispatch=e=>{if(this.cm.update([e]),this.updating)return;const t=(this.getPos()??0)+1,r=e.state.doc.toString(),o=Jt(this.node.textContent,r);if(o){const{text:s,from:i,to:a}=o,l=s?this.pmSchema.text(s):null,u=this.pmView.state.tr.replaceWith(i+t,a+t,l);this.pmView.dispatch(u)}this.forwardSelection()};update=e=>{if(e.type!==this.node.type)return!1;e.attrs.lang!==this.node.attrs.lang&&this.setLanguage(e.attrs.lang),e.attrs.isDarkMode!=null&&e.attrs.isDarkMode!==this.node.attrs.isDarkMode&&this.setTheme(e.attrs.isDarkMode),this.node=e;const t=Jt(this.cm.state.doc.toString(),e.textContent);if(t){const{text:r,from:o,to:s}=t;this.updating=!0,this.cm.dispatch({changes:{from:o,to:s,insert:r}}),this.updating=!1}return!0};asProseMirrorSelection=e=>{const t=(this.getPos()??0)+2,{anchor:r,head:o}=this.cm.state.selection.main;return Z.create(e,r+t,o+t)};forwardSelection=()=>{if(!this.cm.hasFocus)return;const{state:e}=this.pmView,t=this.asProseMirrorSelection(e.doc);t.eq(e.selection)||this.pmView.dispatch(e.tr.setSelection(t))};maybeEscape=(e,t)=>r=>{const{state:o}=r,{selection:s}=o,a=(()=>{const h=s.main.from,{number:p,from:m}=o.doc.lineAt(h);return{line:p,ch:h-m}})(),l=o.selection.ranges.some(h=>!h.empty),u=1,c=o.doc.lineAt(o.doc.length).number;if(l||a.line!==(t<0?u:c)||e==="char"&&a.ch!==(t<0?0:o.doc.line(a.line).length))return!1;const d=(this.getPos()??0)+(t<0?0:this.node.nodeSize),f=Mt.near(this.pmView.state.doc.resolve(d),t);return this.pmView.dispatch(this.pmView.state.tr.setSelection(f).scrollIntoView()),this.pmView.focus(),!0};setSelection=(e,t)=>{this.focus(),this.updating=!0,this.cm.dispatch({selection:{anchor:e,head:t}}),this.updating=!1};focus=()=>{this.cm.focus(),this.forwardSelection()};selectNode=()=>{this.focus()};stopEvent=()=>!0;destroy=()=>{this.cm.destroy()};_setIsCodeBlockView=()=>{this.cm.dom.dataset.isCodeBlockView="true"};static _getIsCodeBlockView=e=>e.dataset.isCodeBlockView==="true";static isInCodeBlockView(e){return e instanceof HTMLElement?e.closest("[data-is-code-block-view]")!=null:!1}}function Us(n,e,t){try{return e instanceof Z?Z.create(n,e.anchor,e.head):e instanceof lo?Z.create(n,e.from,e.to):e instanceof jt?new jt(n):void 0}catch{return Z.create(n,0)}}class Ws extends W{unistNodeName(){return"blockquote"}static proseMirrorNodeName(){return"blockquote"}proseMirrorNodeSpec(){return{content:"block+",group:"block",parseDOM:[{tag:"blockquote"}],toDOM(){return["blockquote",0]}}}proseMirrorInputRules(e){return[mt(/^\s{0,3}>\s$/,e.nodes[this.proseMirrorNodeName()])]}proseMirrorKeymap(e){return{"Mod->":co(e.nodes[this.proseMirrorNodeName()])}}unistNodeToProseMirrorNodes({schema:e,convertedChildren:t,attrs:r}){return q(this.proseMirrorNodeName(),e,t,r)}proseMirrorNodeToUnistNodes(e,t){return[{type:this.unistNodeName(),children:t}]}}function Ks(n,e,t,r){for(let o=0;o<e.length;o++){let{$from:s,$to:i}=e[o],a=s.depth===0?n.inlineContent&&n.type.allowsMarkType(t):!1;if(n.nodesBetween(s.pos,i.pos,(l,u)=>{if(a||!r)return!1;a=l.inlineContent&&l.type.allowsMarkType(t)}),a)return!0}return!1}function en(n){return/^\s*/.exec(n)?.[0]?.length??0}function tn(n){return/\s*$/.exec(n)?.[0]?.length??0}function Gs(n,e,t){for(;e>0;){const r=e-1;if(!n.rangeHasMark(r,e,t))break;e=r}return e}function Xs(n,e,t){for(;e<n.content.size&&n.rangeHasMark(e,e+1,t);)e+=1;return e}function Wn(n,e,t,r=null){const{selection:o}=n;if(!(o instanceof Z))return!1;let{empty:s,$cursor:i,ranges:a}=o;if(s&&!i||!Ks(n.doc,a,t,!0))return!1;if(i)t.isInSet(n.storedMarks||i.marks())?e(n.tr.removeStoredMark(t)):e(n.tr.addStoredMark(t.create(r)));else{let l=n.tr;const u=!a.some(c=>n.doc.rangeHasMark(c.$from.pos,c.$to.pos,t));for(let c=0;c<a.length;c++){let{$from:d,$to:f}=a[c],h=d.pos,p=f.pos;const m=n.doc.textBetween(h,p,`
`);if(/^\s*$/.test(m))continue;const M=d.nodeBefore?.text??"",x=d.nodeAfter?.text??"",y=f.nodeBefore?.text??"",N=f.nodeAfter?.text??"";if(u){let E=en(x),T=tn(y);h+E<p&&(h+=E,p-=T),h=Gs(n.doc,h,t),p=Xs(n.doc,p,t),l.removeMark(h,p,n.schema.marks[Ke.proseMirrorMarkName()]),l.addMark(h,p,t.create(r))}else{const E=tn(M),T=en(N);h-=E,p+=T,l.removeMark(h,p,t)}}e(l.scrollIntoView())}return!0}function nn(n,e=null){return(t,r)=>r?Wn(t,r,n,e):!0}class se extends Nn{markType;constructor(e,t){super(e,(r,o,s,i)=>this.markHandler(r,o,s,i)),this.markType=t}static markApplies(e,t,r){for(const o of t){const{$from:s,$to:i}=o;let a=s.depth===0?e.type.allowsMarkType(r):!1;if(e.nodesBetween(s.pos,i.pos,l=>a?!1:(a=l.inlineContent&&l.type.allowsMarkType(r),!0)),a)return!0}return!1}markHandler(e,t,r,o){if(!(e.selection instanceof Z))return null;const s=e.doc.resolve(r),i=e.doc.resolve(o),a=[new uo(s,i)];if(!se.markApplies(e.doc,a,this.markType))return null;const l=e.doc.nodeAt(r)?.marks.map(c=>c.type)??[];l.push(this.markType);const u=e.tr.replaceWith(r,o,this.markType.schema.text(t[1]));for(const c of l)u.addMark(u.mapping.map(r),u.mapping.map(o),c.create(null));for(const c of l)u.removeStoredMark(c);return u.insertText(t[2])}}class Kn extends Ce{unistNodeName(){return"strong"}static proseMirrorMarkName(){return"strong"}proseMirrorMarkSpec(){return{parseDOM:[{tag:"b"},{tag:"strong"},{style:"font-weight",getAttrs:e=>/^(bold(er)?|[5-9]\d{2,})$/.test(e)&&null}],toDOM(){return["strong"]}}}proseMirrorInputRules(e){return[new se(/\*\*([^\s](?:.*[^\s])?)\*\*([\s\S])$/,e.marks[this.proseMirrorMarkName()]),new se(/__([^\s](?:.*[^\s])?)__([\s\S])$/,e.marks[this.proseMirrorMarkName()])]}proseMirrorKeymap(e){const t=e.marks[this.proseMirrorMarkName()];return{"Mod-b":nn(t),"Mod-B":nn(t)}}unistNodeToProseMirrorNodes({schema:e,convertedChildren:t,attrs:r}){return t.map(o=>o.mark(o.marks.concat([e.marks[this.proseMirrorMarkName()].create(r)])))}processConvertedUnistNode(e){return{type:this.unistNodeName(),children:[e]}}}const Gn=92,Ys=10,Ue="backslashEscape";function Zs(n,e,t){function r(o){return o==null||o===Ys?(n.exit(Ue),e(o)):t(o)}return o=>o!==Gn?t(o):(n.enter(Ue),n.consume(o),r)}function qs(){return{text:{[Gn]:{name:Ue,tokenize:Zs}}}}function Js(){const n=this.data();n.micromarkExtensions??=[],n.micromarkExtensions.push(qs()),n.fromMarkdownExtensions??=[],n.fromMarkdownExtensions.push({enter:{[Ue](e){this.enter({type:"break"},e),this.exit(e)}}})}class Qs extends W{unistNodeName(){return"break"}static proseMirrorNodeName(){return"hard_break"}proseMirrorNodeSpec(){return{inline:!0,group:"inline",selectable:!1,parseDOM:[{tag:"br"}],marks:Ke.proseMirrorMarkName(),toDOM(){return["br"]}}}proseMirrorKeymap(e){const t=Tn(po,(o,s)=>(s&&s(o.tr.replaceSelectionWith(e.nodes[this.proseMirrorNodeName()].create()).scrollIntoView()),!0)),r=typeof navigator<"u"?/Mac|iP(hone|[oa]d)/.test(navigator.platform):!1;return{"Mod-Enter":t,"Shift-Enter":t,...r&&{"Ctrl-Enter":t}}}unistNodeToProseMirrorNodes({schema:e,convertedChildren:t,attrs:r}){return q(this.proseMirrorNodeName(),e,t,r)}proseMirrorNodeToUnistNodes(){return[{type:this.unistNodeName()}]}unifiedInitializationHook(e){return e.use(Js)}}const Ge="code_block",rn="```\n";function ei(n,e){const{start:t,end:r}=n;return t==null||r==null?null:{start:t+rn.length+(e.lang??"").length,end:r-rn.length}}class ut extends W{dependencies(){return[new ht]}unistNodeName(){return"code"}static proseMirrorNodeName(){return Ge}proseMirrorNodeSpec(){return{content:"text*",group:"block",code:!0,defining:!0,marks:[Ke.proseMirrorMarkName()].join(" "),attrs:{lang:{default:null},isDarkMode:{default:null}},parseDOM:[{tag:"pre",preserveWhitespace:"full"}],toDOM(){return["pre",["code",0]]}}}proseMirrorInputRules(e){return[Ar(/^\s{0,3}```$/,e.nodes[this.proseMirrorNodeName()])]}unistNodeToProseMirrorNodes({node:e,attrs:t,schema:r}){const{lang:o}=e;return q(this.proseMirrorNodeName(),r,Ln(e,r,{...t,...ei(t,e)??{}}),{lang:o,...t})}proseMirrorNodeToUnistNodes(e,t){return[{type:this.unistNodeName(),value:t.map(r=>r.type==="startend"?r.children.map(o=>o.value).join(""):r.value).join(""),lang:e.attrs.lang}]}}class Xn extends W{unistNodeName(){return"textDirective"}static proseMirrorNodeName(){return be}proseMirrorNodeSpec(){return{group:"inline",inline:!0,content:"inline*",atom:!0,attrs:{index:{default:null},displayLayout:{default:"inline"}},toDOM:e=>["span",{"data-type":"content-reference","data-content-reference-index":e.attrs.index,"data-display-layout":e.attrs.displayLayout},`:contentReference[oaicite:${e.attrs.index}]{index="${e.attrs.index}" displayLayout="${e.attrs.displayLayout}"}`],parseDOM:[{tag:'span[data-type="content-reference"]',getAttrs(e){return{index:e.getAttribute("data-index"),displayLayout:e.getAttribute("data-display-layout")||"inline"}}}]}}unistNodeToProseMirrorNodes({node:e,schema:t,convertedChildren:r}){if(!Xo(e)||e.name!==be||e.type!==this.unistNodeName())return xt.addError("ContentReferenceExtension: unistNodeToProseMirrorNodes: node is not a directive node or name is not contentReference",e),null;const o={index:e.attributes?.index,displayLayout:e.attributes?.displayLayout??"inline"};return t.nodes.contentReference.create(o,r)}proseMirrorNodeToUnistNodes(e,t){if(t.length!==1)return console.warn("ContentReferenceExtension: proseMirrorNodeToUnistNodes: convertedChildren.length != 1",t),[];const s=[{type:"text",value:t[0].children[0].value}];return[{type:"textDirective",name:be,attributes:{index:e.attrs.index,displayLayout:e.attrs.displayLayout},children:s,data:{hName:be,hProperties:{displayLayout:e.attrs.displayLayout,index:e.attrs.index}}}]}}class ti extends W{unistNodeName(){return"thematicBreak"}static proseMirrorNodeName(){return"horizontal_rule"}proseMirrorNodeSpec(){return{group:"block",parseDOM:[{tag:"hr"}],toDOM(){return["div",["hr"]]}}}proseMirrorInputRules(e){return[new Nn(/^\s{0,3}(?:\*\*\*|---|___)\n$/,(t,r,o,s)=>t.tr.replaceWith(o,s,q(this.proseMirrorNodeName(),e,[])??[]))]}proseMirrorKeymap(e){return{"Mod-_":(t,r)=>(r&&r(t.tr.replaceSelectionWith(e.nodes[this.proseMirrorNodeName()].create()).scrollIntoView()),!0)}}unistNodeToProseMirrorNodes({schema:e,convertedChildren:t,attrs:r}){return q(this.proseMirrorNodeName(),e,t,r)}proseMirrorNodeToUnistNodes(){return[{type:this.unistNodeName()}]}}class ni extends Ce{unistNodeName(){return"inlineCode"}static proseMirrorMarkName(){return"code"}proseMirrorMarkSpec(){return{inclusive:!1,parseDOM:[{tag:"code"}],toDOM(){return["code"]}}}proseMirrorInputRules(e){return[new se(/`([^\s](?:.*[^\s])?)`([\s\S])$/,e.marks[this.proseMirrorMarkName()])]}proseMirrorKeymap(e){const t=e.marks[this.proseMirrorMarkName()];return{"Ctrl-`":ot(t)}}unistNodeToProseMirrorNodes({node:e,schema:t,attrs:r}){const o=Ln(e,t,r,[t.marks[this.proseMirrorMarkName()].create(r)]);return o?[o]:[]}processConvertedUnistNode(e){return{type:this.unistNodeName(),value:e.value}}}class Yn extends Ce{unistNodeName(){return"emphasis"}static proseMirrorMarkName(){return"em"}proseMirrorMarkSpec(){return{parseDOM:[{tag:"i"},{tag:"em"},{style:"font-style",getAttrs:e=>e==="italic"&&null}],toDOM(){return["em"]}}}proseMirrorInputRules(e){try{return[new se(new RegExp("(?<!\\*)\\*([^\\s*](?:.*[^\\s])?)\\*([^*])$"),e.marks[this.proseMirrorMarkName()]),new se(new RegExp("(?<!_)_([^\\s_](?:.*[^\\s])?)_([^_])$"),e.marks[this.proseMirrorMarkName()])]}catch(t){return xt.addError(t),[]}}proseMirrorKeymap(e){const t=e.marks[this.proseMirrorMarkName()];return{"Mod-i":ot(t),"Mod-I":ot(t)}}unistNodeToProseMirrorNodes({schema:e,convertedChildren:t,attrs:r}){return t.map(o=>o.mark(o.marks.concat([e.marks[this.proseMirrorMarkName()].create(r)])))}processConvertedUnistNode(e){return{type:this.unistNodeName(),children:[e]}}}function Zn(n){return"children"in n}const ke="lineEndingBlank";function on(n){return n.type===ke}const ri=({startIndex:n,endIndex:e,depth:t,isLastChild:r,parent:o=null})=>{const s=e-n;return t>0&&o?.type!=="list"?s:r||n===0?s-Math.floor((s+1)/2):s-Math.floor((s-1)/2)};function oi(){const n=this.data();n.fromMarkdownExtensions??=[],n.fromMarkdownExtensions.push({enter:{lineEndingBlank(t){this.enter({type:ke},t)}},exit:{lineEndingBlank(t){this.exit(t)}}});const e=(t,r=0)=>{if(!Zn(t))return;const{children:o}=t;let s=0,i=null,a=null;const l=o.length;for(let u=0;u<l;u++){const c=o[u-s];e(c,r+1);const{type:d}=c,h=u===l-1&&d===ke;if(d===ke&&i==null?i=u:d!==ke&&i!=null?a=u:h&&i!=null&&(a=u+1),i!=null&&a!=null){const p=ri({startIndex:i,endIndex:a,depth:r,isLastChild:h,parent:t});o.splice(i-s,p),i=null,a=null,s+=p}}};return t=>{e(t)}}class si extends W{unistNodeName(){return ke}static proseMirrorNodeName(){return"paragraph"}proseMirrorNodeSpec(){return Ir}unistNodeToProseMirrorNodes({schema:e,convertedChildren:t,attrs:r}){return q(this.proseMirrorNodeName(),e,t,r)}proseMirrorNodeToUnistNodes(e,t){return[{type:Or,children:t}]}unifiedInitializationHook(e){return e.use(oi)}}function qn(n,e=null){return function(t,r){let{$from:o,$to:s}=t.selection,i=o.blockRange(s),a=!1,l=i;if(!i)return!1;if(i.depth>=2&&o.node(i.depth-1).type.compatibleContent(n)&&i.startIndex==0){if(o.index(i.depth-1)==0)return!1;let c=t.doc.resolve(i.start-2);l=new st(c,c,i.depth),i.endIndex<i.parent.childCount&&(i=new st(o,t.doc.resolve(s.end(i.depth)),i.depth)),a=!0}let u=fo(l,n,e,i);return u?(r&&r(ii(t.tr,i,u,a,n).scrollIntoView()),!0):!1}}function ii(n,e,t,r,o){let s=F.empty;for(let c=t.length-1;c>=0;c--)s=F.from(t[c].type.create(t[c].attrs,s));n.step(new Se(e.start-(r?2:0),e.end,e.start,e.end,new Pe(s,0,0),t.length,!0));let i=0;for(let c=0;c<t.length;c++)t[c].type==o&&(i=c+1);let a=t.length-i,l=e.start+t.length-(r?2:0),u=e.parent;for(let c=e.startIndex,d=e.endIndex,f=!0;c<d;c++,f=!1)!f&&Sn(n.doc,l,a)&&(n.split(l,a),l+=2*a),l+=u.child(c).nodeSize;return n}function ai(n,e){return function(t,r){let{$from:o,$to:s,node:i}=t.selection;if(i&&i.isBlock||o.depth<2||!o.sameParent(s))return!1;let a=o.node(-1);if(a.type!=n)return!1;if(o.parent.content.size==0&&o.node(-1).childCount==o.indexAfter(-1)){if(o.depth==3||o.node(-3).type!=n||o.index(-2)!=o.node(-2).childCount-1)return!1;if(r){let d=F.empty,f=o.index(-1)?1:o.index(-2)?2:3;for(let x=o.depth-f;x>=o.depth-3;x--)d=F.from(o.node(x).copy(d));let h=o.indexAfter(-1)<o.node(-2).childCount?1:o.indexAfter(-2)<o.node(-3).childCount?2:3;d=d.append(F.from(n.createAndFill()));let p=o.before(o.depth-(f-1)),m=t.tr.replace(p,o.after(-h),new Pe(d,4-f,0)),M=-1;m.doc.nodesBetween(p,m.doc.content.size,(x,y)=>{if(M>-1)return!1;x.isTextblock&&x.content.size==0&&(M=y+1)}),M>-1&&m.setSelection(Mt.near(m.doc.resolve(M))),r(m.scrollIntoView())}return!0}let l=s.pos==o.end()?a.contentMatchAt(0).defaultType:null,u=t.tr.delete(o.pos,s.pos),c=l?[null,{type:l}]:void 0;return Sn(u.doc,o.pos,2,c)?(r&&r(u.split(o.pos,2,c).scrollIntoView()),!0):!1}}function li(n){return function(e,t){let{$from:r,$to:o}=e.selection,s=r.blockRange(o,i=>i.childCount>0&&i.firstChild.type==n);return s?t?r.node(s.depth-1).type==n?ci(e,t,n,s):ui(e,t,s):!0:!1}}function ci(n,e,t,r){let o=n.tr,s=r.end,i=r.$to.end(r.depth);s<i&&(o.step(new Se(s-1,i,s,i,new Pe(F.from(t.create(null,r.parent.copy())),1,0),1,!0)),r=new st(o.doc.resolve(r.$from.pos),o.doc.resolve(i),r.depth));const a=ho(r);if(a==null)return!1;o.lift(r,a);let l=o.mapping.map(s,-1)-1;return mo(o.doc,l)&&o.join(l),e(o.scrollIntoView()),!0}function ui(n,e,t){let r=n.tr,o=t.parent;for(let h=t.end,p=t.endIndex-1,m=t.startIndex;p>m;p--)h-=o.child(p).nodeSize,r.delete(h-1,h+1);let s=r.doc.resolve(t.start),i=s.nodeAfter;if(r.mapping.map(t.end)!=t.start+s.nodeAfter.nodeSize)return!1;let a=t.startIndex==0,l=t.endIndex==o.childCount,u=s.node(-1),c=s.index(-1);if(!u.canReplace(c+(a?0:1),c+1,i.content.append(l?F.empty:F.from(o))))return!1;let d=s.pos,f=d+i.nodeSize;return r.step(new Se(d-(a?1:0),f+(l?1:0),d+1,f-1,new Pe((a?F.empty:F.from(o.copy(F.empty))).append(l?F.empty:F.from(o.copy(F.empty))),a?0:1,l?0:1),a?0:1)),e(r.scrollIntoView()),!0}function di(n){return function(e,t){let{$from:r,$to:o}=e.selection,s=r.blockRange(o,u=>u.childCount>0&&u.firstChild.type==n);if(!s)return!1;let i=s.startIndex;if(i==0)return!1;let a=s.parent,l=a.child(i-1);if(l.type!=n)return!1;if(t){let u=l.lastChild&&l.lastChild.type==a.type,c=F.from(u?n.create():null),d=new Pe(F.from(n.create(null,F.from(a.type.create(null,c)))),u?3:1,0),f=s.start,h=s.end;t(e.tr.step(new Se(f-(u?3:1),h,f,h,d,1,!0)).scrollIntoView())}return!0}}class vt extends W{unistNodeName(){return"listItem"}static proseMirrorNodeName(){return"regular_list_item"}proseMirrorNodeSpec(){return{content:"paragraph block*",defining:!0,group:"list_item",parseDOM:[{tag:"li"}],toDOM(){return["li",0]}}}unistToProseMirrorTest(e){return e.type===this.unistNodeName()&&(!("checked"in e)||typeof e.checked!="boolean")}proseMirrorKeymap(e){const t=e.nodes[this.proseMirrorNodeName()];return{Enter:ai(t),"Shift-Tab":li(t),Tab:di(t)}}unistNodeToProseMirrorNodes({schema:e,convertedChildren:t,attrs:r}){return q(this.proseMirrorNodeName(),e,t,r)}proseMirrorNodeToUnistNodes(e,t){return[{type:this.unistNodeName(),children:t}]}}class pi extends W{dependencies(){return[new vt]}unistNodeName(){return"list"}unistToProseMirrorTest(e){return e.type===this.unistNodeName()&&e.ordered===!0}static proseMirrorNodeName(){return"ordered_list"}proseMirrorNodeSpec(){return{content:"list_item+",group:"block",attrs:{spread:{default:!1},startingNumber:{default:1}},parseDOM:[{getAttrs(e){const t=e.getAttribute("start");return{spread:e.getAttribute("data-spread")==="true",startingNumber:t!=null?parseInt(t):1}},tag:"ol"}],toDOM(e){return["ol",{"data-spread":e.attrs.spread,start:e.attrs.startingNumber},0]}}}proseMirrorInputRules(e){return[mt(/^\s{0,3}(\d+)\.\s$/,e.nodes[this.proseMirrorNodeName()],t=>({startingNumber:+t[1]}),(t,r)=>r.childCount+r.attrs.startingNumber===+t[1])]}proseMirrorKeymap(e){return{"Shift-Mod-9":qn(e.nodes[this.proseMirrorNodeName()])}}unistNodeToProseMirrorNodes({node:e,schema:t,convertedChildren:r,attrs:o}){const{spread:s,start:i}=e;return q(this.proseMirrorNodeName(),t,r,{...o,spread:s,startingNumber:i??1})}proseMirrorNodeToUnistNodes(e,t){const r=e.attrs.spread;return[{type:this.unistNodeName(),ordered:!0,spread:r,start:e.attrs.startingNumber,children:t.map(o=>(o.spread=r,o))}]}}class fi extends Ce{unistNodeName(){return"delete"}static proseMirrorMarkName(){return"strikethrough"}proseMirrorMarkSpec(){return{parseDOM:[{tag:"s"},{tag:"del"},{style:"text-decoration",getAttrs:e=>/(^|[\s])line-through([\s]|$)/.test(e)&&null}],toDOM(){return["s"]}}}proseMirrorInputRules(e){return[new se(/~([^\s](?:.*[^\s~])?)~([^~])$/,e.marks[this.proseMirrorMarkName()]),new se(/~~([^\s](?:.*[^\s])?)~~([\s\S])$/,e.marks[this.proseMirrorMarkName()])]}unistNodeToProseMirrorNodes({schema:e,convertedChildren:t}){return t.map(r=>r.mark(r.marks.concat([e.marks[this.proseMirrorMarkName()].create()])))}processConvertedUnistNode(e){return{type:this.unistNodeName(),children:[e]}}}function hi(){return n=>{let e=-1;function t(o,s){if(o.type==="tableRow"&&e++,o.type==="tableCell"){const i=o;i.data={...i.data??{},rowIndex:e,columnIndex:s}}}function r(o){if(Zn(o))for(let s=0;s<o.children.length;s++){const i=o.children[s];t(i,s),r(i)}}r(n)}}class Jn extends W{unistNodeName(){return"tableCell"}unistToProseMirrorTest(e){return e.type===this.unistNodeName()}static proseMirrorNodeName(){return"table_cell"}proseMirrorNodeSpec(){return{content:"inline*",attrs:{rowIndex:{default:null},columnIndex:{default:null},colspan:{default:1},rowspan:{default:1}},tableRole:"cell",isolating:!0,parseDOM:[{tag:"td",getAttrs(e){const t=e;return{colspan:at(t.getAttribute("colspan"),1),rowspan:at(t.getAttribute("rowspan"),1)}}}],toDOM(e){const{colspan:t,rowspan:r}=e.attrs,o={colspan:t!==1?Ut(t,void 0):void 0,rowspan:r!==1?Ut(r,void 0):void 0};return[e.attrs.rowIndex==null||e.attrs.rowIndex>0?"td":"th",o,0]}}}proseMirrorInputRules(e){return[]}proseMirrorKeymap(e){return{}}unistNodeToProseMirrorNodes({node:e,schema:t,convertedChildren:r,attrs:o}){return q(this.proseMirrorNodeName(),t,r,{...o,colspan:1,rowspan:1,rowIndex:e.data?.rowIndex,columnIndex:e.data?.columnIndex})}proseMirrorNodeToUnistNodes(e,t){return[{type:this.unistNodeName(),children:t,data:{rowIndex:e.attrs.rowIndex,columnIndex:e.attrs.columnIndex}}]}}class Qn extends W{dependencies(){return[new Jn]}unistNodeName(){return"tableRow"}static proseMirrorNodeName(){return"table_row"}proseMirrorNodeSpec(){return{content:"(table_cell+)",tableRole:"row",parseDOM:[{tag:"tr"}],toDOM(){return["tr",0]}}}proseMirrorInputRules(e){return[]}proseMirrorKeymap(e){return{}}unistNodeToProseMirrorNodes({schema:e,convertedChildren:t,attrs:r}){return q(this.proseMirrorNodeName(),e,t,r)}proseMirrorNodeToUnistNodes(e,t){return[{type:this.unistNodeName(),children:t}]}}class mi extends W{dependencies(){return[new Qn]}unistNodeName(){return"table"}static proseMirrorNodeName(){return"table"}proseMirrorNodeSpec(){return{content:"(table_row+)",tableRole:"table",isolating:!0,group:"block",parseDOM:[{tag:"table"}],toDOM(){return["table",["tbody",0]]}}}proseMirrorInputRules(e){return[]}proseMirrorKeymap(e){return{}}unistNodeToProseMirrorNodes({schema:e,convertedChildren:t,attrs:r}){return q(this.proseMirrorNodeName(),e,t,r)}proseMirrorNodeToUnistNodes(e,t){return[{type:this.unistNodeName(),align:[],children:t}]}unifiedInitializationHook(e){return e.use(hi)}}class gi extends W{dependencies(){return[new vt]}unistNodeName(){return"list"}unistToProseMirrorTest(e){return e.type===this.unistNodeName()&&e.ordered!==!0}static proseMirrorNodeName(){return"list"}proseMirrorNodeSpec(){return{content:"list_item+",group:"block",attrs:{spread:{default:!1}},parseDOM:[{getAttrs(e){return{spread:e.getAttribute("data-spread")==="true"}},tag:"ul"}],toDOM(e){return["ul",{"data-spread":e.attrs.spread},0]}}}proseMirrorInputRules(e){return[mt(/^\s{0,3}([-+*])\s$/,e.nodes[this.proseMirrorNodeName()])]}proseMirrorKeymap(e){return{"Shift-Mod-8":qn(e.nodes[this.proseMirrorNodeName()])}}unistNodeToProseMirrorNodes({node:e,schema:t,convertedChildren:r,attrs:o}){const{spread:s}=e;return q(this.proseMirrorNodeName(),t,r,{...o,spread:s})}proseMirrorNodeToUnistNodes(e,t){const r=e.attrs.spread;return[{type:this.unistNodeName(),ordered:!1,spread:r,children:t.map(o=>(o.spread=r,o))}]}}function sn(n,e){if(!(n==null||e==null))return{start:{...n},end:{...e}}}const Mi=()=>n=>{Bo(n,"list",(e,t,r)=>{if(r==null||t==null)return;const o=[];let s=[],i=0;for(;i<e.children.length;){const a=e.children[i];if(on(a)){const l=[];for(;i<e.children.length&&on(e.children[i]);)l.push(e.children[i]),i++;if(s.length===0)throw new Error("Unexpected state: currentListItems is empty after encountering blank lines.");const u=s[0],c=Re(On(s)),d=sn(u.position?.start??e.position?.start,c.position?.end??e.position?.end),f={type:"list",ordered:e.ordered,start:e.start,spread:e.spread,children:s,position:d};o.push(f),s=[],o.push(...l.map(h=>({type:"lineEndingBlank",position:h.position})))}else s.push(a),i++}if(s.length>0){const a=s[0],l=s[s.length-1],u=sn(a.position?.start??e.position?.start,l.position?.end??e.position?.end),c={type:"list",ordered:e.ordered,start:e.start,spread:e.spread,children:s,position:u};o.push(c)}r.children.splice(t,1,...o)})},wi=(n,e,t,r)=>n.children.map(o=>t.handle(o,void 0,t,r)).join(""),Ni=(n,e,t,r)=>t.safe(n.value,r).replaceAll("\\[","[").replaceAll("\\&","&");function ki(){const n=this;n.compiler=e;function e(t){return Ms(t,{...n.data("settings"),fences:!0,bullet:"-",bulletOther:"*",listItemIndent:"one",resourceLink:!0,tightDefinitions:!0,rule:"-",handlers:{text:Ni,startend:wi},extensions:n.data("toMarkdownExtensions")||[]})}}class xi extends Gr{dependencies(){const e=wt();return[new si,new kn,new Ws,new Kn,new Qs,new ut,new xn,new ti,new ni,new Yn,new zn,new vt,new pi,new Dr,new ht,new gi,new fi,new Ke,new mi,new Qn,new Jn,...e?[new Xn]:[]]}unifiedInitializationHook(e){return e.use(Jo).use(Yo).use(Mi).use(ki)}}class yi{rules;constructor(e,t){this.rules=[].concat.apply([],e.syntaxExtensions().map(r=>r.proseMirrorInputRules(t)))}build(){return _r({rules:this.rules})}}class Ci{keymap;constructor(e,t){this.keymap=new Map;for(const r of e.syntaxExtensions())this.addKeymap(r.proseMirrorKeymap(t));this.addKeymap(go)}build(){const e={};return this.keymap.forEach((t,r)=>{e[r]=Tn(...t)}),Nt(e)}addKeymap(e){for(const t in e)this.keymap.get(t)||this.keymap.set(t,[]),Re(this.keymap.get(t)).push(e[t])}}class Ei{nodeViews;constructor(e){this.nodeViews={};for(const t of e.nodeExtensions()){const r=t.proseMirrorNodeName(),o=t.proseMirrorNodeView();r!==Xn.proseMirrorNodeName()&&r!=null&&o!=null&&(this.nodeViews[r]=o)}}build(){return this.nodeViews}}class bi{nodes={};marks={};constructor(e){for(const t of e.nodeExtensions()){const r=t.proseMirrorNodeName(),o=t.proseMirrorNodeSpec();r!=null&&o!=null&&(r!=="text"&&(o.attrs={...o.attrs,start:{default:void 0},end:{default:void 0}}),this.nodes[r]=o)}for(const t of e.markExtensions()){const r=t.proseMirrorMarkName(),o=t.proseMirrorMarkSpec();r!=null&&o!=null&&(this.marks[r]=o)}}build(){return new Mo({nodes:this.nodes,marks:this.marks})}}class vi{extensionManager;constructor(e){this.extensionManager=e}build(){let e=Qo();for(const t of this.extensionManager.extensions())e=t.unifiedInitializationHook(e);return e}}function Ti(n){return n instanceof W}function Si(n){return n instanceof Ce}class Pi{markExtensionList;nodeExtensionList;otherExtensionList;constructor(e){this.markExtensionList=new Map,this.nodeExtensionList=new Map,this.otherExtensionList=new Map;for(const t of e)this.add(t)}extensions(){return this.syntaxExtensions().concat(Array.from(this.otherExtensionList.values()))}markExtensions(){return Array.from(this.markExtensionList.values())}getMarkExtension(e){return this.markExtensionList.get(e)??null}nodeExtensions(){return Array.from(this.nodeExtensionList.values())}getNodeExtension(e){return this.nodeExtensionList.get(e)??null}syntaxExtensions(){return this.nodeExtensions().concat(this.markExtensions())}add(e){for(const t of e.dependencies())this.add(t);if(Si(e)){this.markExtensionList.set(e.constructor.name,e);return}if(Ti(e)){this.nodeExtensionList.set(e.constructor.name,e);return}this.otherExtensionList.set(e.constructor.name,e)}}class Ri{extensionManager;constructor(e){this.extensionManager=e}convert(e){const t=this.convertNode(e);if(t.length!==1)throw new Error("Couldn't find any way to convert the root ProseMirror node.");return t[0]}convertNode(e){let t=null;const r=[];for(const o of this.extensionManager.nodeExtensions()){if(!o.proseMirrorToUnistTest(e))continue;r.push(o);let s=[];for(let i=0;i<e.childCount;++i)s=s.concat(this.convertNode(e.child(i)));t=o.proseMirrorNodeToUnistNodes(e,s)}return t==null?(console.warn(`Couldn't find any way to convert ProseMirror node of type "`+e.type.name+'" to a unist node.'),[]):t.map(o=>{for(const s of e.marks){const{type:{name:i}}=s;if(r.some(u=>{const c=u.proseMirrorNodeSpec()?.marks;return c!=null&&!c.includes(i)}))continue;let l=!1;for(const u of this.extensionManager.markExtensions())s.type.name===u.proseMirrorMarkName()&&(o=u.processConvertedUnistNode(o,s),l=!0);l||console.warn(`Couldn't find any way to convert ProseMirror mark of type "`+i+'" to a unist node.')}return o})}}class Tt{extensionManager;proseMirrorSchema;constructor(e,t){this.extensionManager=e,this.proseMirrorSchema=t}static unistNodeIsParent(e){return"children"in e}convert(e){const t={},r=this.convertNode(e,t);for(const o of this.extensionManager.syntaxExtensions())o.postUnistToProseMirrorHook(t);if(r.length!==1)throw new Error("Couldn't find any way to convert the root unist node.");return r[0]}convertNode(e,t){let r=0;const o=(s,i)=>{for(const a of this.extensionManager.syntaxExtensions()){if(!a.unistToProseMirrorTest(s))continue;let l=[];Tt.unistNodeIsParent(s)&&(l=s.children.flatMap(p=>o(p,i)));const{position:u}=s;let c=u?.start.offset??r,d=u?.end.offset;if(d==null&&"value"in s&&typeof s.value=="string"){const{value:p}=s;d=c+p.length}d==null&&(d=c),r=d;const f={start:c,end:d};return Lo(a.unistNodeToProseMirrorNodes({node:s,schema:this.proseMirrorSchema,convertedChildren:l,context:i,attrs:f})).filter(Vo)}return console.warn(`Couldn't find any way to convert unist node of type "`+s.type+'" to a ProseMirror node.'),[]};return o(e,t)}}const Ai=5;class Ii{builtSchema;inputRulesBuilder;keymapBuilder;nodeViewBuilder;unistToProseMirrorConverter;proseMirrorToUnistConverter;unified;memoizedProsemirrorDocs=new Map;constructor(e=[]){const t=new Pi(e);this.builtSchema=new bi(t).build(),this.inputRulesBuilder=new yi(t,this.builtSchema),this.keymapBuilder=new Ci(t,this.builtSchema),this.nodeViewBuilder=new Ei(t),this.unistToProseMirrorConverter=new Tt(t,this.builtSchema),this.proseMirrorToUnistConverter=new Ri(t),this.unified=new vi(t).build()}parse(e){try{if(this.memoizedProsemirrorDocs.has(e))return Re(this.memoizedProsemirrorDocs.get(e));const t=this.unistToProseMirrorConverter.convert(this.parseUnist(e));if(this.memoizedProsemirrorDocs.set(e,t),this.memoizedProsemirrorDocs.size>Ai){const r=this.memoizedProsemirrorDocs.keys().next().value;this.memoizedProsemirrorDocs.delete(r)}return t}catch(t){B.logError("Failed to parse document",t)}return this.schema().text(" ")}parseUnist(e){return this.unified.runSync(this.unified.parse(e))}schema(){return this.builtSchema}inputRulesPlugin(){return this.inputRulesBuilder.build()}keymapPlugin(){return this.keymapBuilder.build()}nodeViews(){return this.nodeViewBuilder.build()}serialize(e){const t=this.proseMirrorToUnistConverter.convert(e);return this.unified.stringify(t)}}let an=null;function he(){return an??=new Ii([new xi]),an}const Oi=(n,e,t,r)=>{const o=[];for(const s of e)for(const i of t)o.push({from:s,to:i,parentNodeNamesAtStart:s.parentNodeTypeNameStack,slice:n.slice(s.pmPos,i.pmPos)});return o.sort((s,i)=>{const a=Math.abs(s.from.sourcePos-r.start)+Math.abs(s.to.sourcePos-r.end),l=Math.abs(i.from.sourcePos-r.start)+Math.abs(i.to.sourcePos-r.end);return a===l?i.slice.size-s.slice.size:a-l}),o},Di=(n,e)=>Co(n.parentNodeNamesAtStart,e.parentNodeTypeNameStack),ln=new WeakMap,_i=({diff:n})=>{const e=new Ho(jo.GetDiffedDoc,{debug:!1});e.startBlock("get_diffed_doc");const t=he(),{contentAfter:r,contentBefore:o,edits:s}=n,i=t.parse(r),a=t.parse(o),l=s.concat().sort((y,N)=>y.positionBefore.start-N.positionBefore.start),u=[],c=[];e.startBlock("init_position_transformers");const{sourceRangeToPmRange:d}=Ve(a),{sourceRangeToPmRange:f}=Ve(i);e.endBlock("init_position_transformers");let h=a,p=0,m=0;const M=[],x=(y,N,E)=>{for(const[T,A]of E.entries())try{if(!Di(N,A))continue;const{pmPos:S}=A,{slice:R}=N;return h=h.replace(S,S,R),u.push({editId:y,start:S,end:S+R.size}),[T,A]}catch(S){M.push(S)}return null};for(let y=0;y<l.length;y++){const{id:N,positionBefore:E,positionAfter:T}=l[y];e.startBlock("transform_positions");const A=d(E),S=f(T);e.endBlock("transform_positions");const{start:R,end:P}=A,{start:D,end:v}=S,w=T.start!==T.end,b=w?Oi(i,D,v,T):null;e.startBlock("get_merged_doc_positions");const{positions:V}=Ve(h);e.endBlock("get_merged_doc_positions");const H=Math.max(...R.map(({pmPos:$})=>$)),L=Math.min(...P.map(({pmPos:$})=>$)),K=[].concat(P).concat(R),_=E.start!==E.end&&a.textBetween(H,L).length>0;let j=!1;if(_&&!w)c.push({editId:N,start:H+p,end:L+p}),j=!0;else if(!_&&!w)j=!0;else{const $=K.map(({pmPos:I})=>V[I+p]);for(const I of b??[]){const U=x(N,I,$);if(U==null)continue;const Q=U[0],ie=I.slice.size,ue=Q<P.length;ue||(p+=ie),_&&c.push({editId:N,start:H+p,end:L+p}),ue&&(p+=ie),j=!0;break}}if(!j&&b!=null){const I=Math.min(...R.map(({pmPos:U})=>U))+p-1;for(const U of b)try{h=h.replace(I,I,U.slice),u.push({editId:N,start:I,end:I+U.slice.size}),p+=U.slice.size,_&&c.push({editId:N,start:H+p,end:L+p}),j=!0;break}catch(Q){M.push(Q)}}j?B.logEvent(le.canvasDiffEditSuccess):(B.logEvent(le.canvasDiffEditFail),B.logError("Failed to insert edit for diffed doc",On(M),{errors:M.map(zo),replaceFromCandidates:R,replaceToCandidates:P,sliceFromCandidates:D,sliceToCandidates:v}),m++)}return B.logDistribution(le.canvasDiffEditSuccessRatio,(l.length-m)/l.length),B.logDistribution(le.canvasDiffEditFailCount,m),B.logDistribution(le.canvasDiffEditSuccessCount,l.length-m),B.logDistribution(le.canvasDiffEditCount,l.length),e.endBlock("get_diffed_doc"),{doc:h,addedRanges:u,deletedRanges:c}},Bi=({diff:n})=>{const e=ln.get(n);if(e!=null)return e;const t=_i({diff:n});return ln.set(n,t),t},_e=new te("focus"),Li=(n,e)=>new ee({key:_e,state:{init:()=>!1,apply(t,r){const o=t.getMeta(_e);return typeof o=="boolean"?o:r}},props:{handleDOMEvents:{blur:(t,r)=>{const{relatedTarget:o}=r;return o!=null&&bt.isInCodeBlockView(o)||(e(r),t.dispatch(t.state.tr.setMeta(_e,!1))),!1},focus:(t,r)=>(n(r),t.dispatch(t.state.tr.setMeta(_e,!0)),!1)}}}),Vi=500;class re{constructor(e,t){this.items=e,this.eventCount=t}popEvent(e,t){if(this.eventCount==0)return null;let r=this.items.length;for(;;r--)if(this.items.get(r-1).selection){--r;break}let o,s;t&&(o=this.remapping(r,this.items.length),s=o.maps.length);let i=e.tr,a,l,u=[],c=[];return this.items.forEach((d,f)=>{if(!d.step){o||(o=this.remapping(r,f+1),s=o.maps.length),s--,c.push(d);return}if(o){c.push(new ne(d.map));let h=d.step.map(o.slice(s)),p;h&&i.maybeStep(h).doc&&(p=i.mapping.maps[i.mapping.maps.length-1],u.push(new ne(p,void 0,void 0,u.length+c.length))),s--,p&&o.appendMap(p,s)}else i.maybeStep(d.step);if(d.selection)return a=o?d.selection.map(o.slice(s)):d.selection,l=new re(this.items.slice(0,r).append(c.reverse().concat(u)),this.eventCount-1),!1},this.items.length,0),{remaining:l,transform:i,selection:a}}addTransform(e,t,r,o){let s=[],i=this.eventCount,a=this.items,l=!o&&a.length?a.get(a.length-1):null;for(let c=0;c<e.steps.length;c++){let d=e.steps[c].invert(e.docs[c]),f=new ne(e.mapping.maps[c],d,t),h;(h=l&&l.merge(f))&&(f=h,c?s.pop():a=a.slice(0,a.length-1)),s.push(f),t&&(i++,t=void 0),o||(l=f)}let u=i-r.depth;return u>ji&&(a=Hi(a,u),i-=u),new re(a.append(s),i)}remapping(e,t){let r=new vn;return this.items.forEach((o,s)=>{let i=o.mirrorOffset!=null&&s-o.mirrorOffset>=e?r.maps.length-o.mirrorOffset:void 0;r.appendMap(o.map,i)},e,t),r}addMaps(e){return this.eventCount==0?this:new re(this.items.append(e.map(t=>new ne(t))),this.eventCount)}rebased(e,t){if(!this.eventCount)return this;let r=[],o=Math.max(0,this.items.length-t),s=e.mapping,i=e.steps.length,a=this.eventCount;this.items.forEach(f=>{f.selection&&a--},o);let l=t;this.items.forEach(f=>{let h=s.getMirror(--l);if(h==null)return;i=Math.min(i,h);let p=s.maps[h];if(f.step){let m=e.steps[h].invert(e.docs[h]),M=f.selection&&f.selection.map(s.slice(l+1,h));M&&a++,r.push(new ne(p,m,M))}else r.push(new ne(p))},o);let u=[];for(let f=t;f<i;f++)u.push(new ne(s.maps[f]));let c=this.items.slice(0,o).append(u).append(r),d=new re(c,a);return d.emptyItemCount()>Vi&&(d=d.compress(this.items.length-r.length)),d}emptyItemCount(){let e=0;return this.items.forEach(t=>{t.step||e++}),e}compress(e=this.items.length){let t=this.remapping(0,e),r=t.maps.length,o=[],s=0;return this.items.forEach((i,a)=>{if(a>=e)o.push(i),i.selection&&s++;else if(i.step){let l=i.step.map(t.slice(r)),u=l&&l.getMap();if(r--,u&&t.appendMap(u,r),l){let c=i.selection&&i.selection.map(t.slice(r));c&&s++;let d=new ne(u.invert(),l,c),f,h=o.length-1;(f=o.length&&o[h].merge(d))?o[h]=f:o.push(d)}}else i.map&&r--},this.items.length,0),new re(Wt.from(o.reverse()),s)}static empty=new re(Wt.empty,0)}function Hi(n,e){let t;return n.forEach((r,o)=>{if(r.selection&&e--==0)return t=o,!1}),n.slice(t)}class ne{constructor(e,t,r,o){this.map=e,this.step=t,this.selection=r,this.mirrorOffset=o}merge(e){if(this.step&&e.step&&!e.selection){let t=e.step.merge(this.step);if(t)return new ne(t.getMap().invert(),t,this.selection)}}}class ce{constructor(e,t,r,o,s){this.done=e,this.undone=t,this.prevRanges=r,this.prevTime=o,this.prevComposition=s}}const ji=20;function zi(n,e,t,r){let o=t.getMeta(me),s;if(o)return o.historyState;t.getMeta(Ui)&&(n=new ce(n.done,n.undone,null,0,-1));let i=t.getMeta("appendedTransaction");if(t.steps.length==0)return n;if(i&&i.getMeta(me))return i.getMeta(me).redo?new ce(n.done.addTransform(t,void 0,r,He(e)),n.undone,cn(t.mapping.maps),n.prevTime,n.prevComposition):new ce(n.done,n.undone.addTransform(t,void 0,r,He(e)),null,n.prevTime,n.prevComposition);if(t.getMeta("addToHistory")!==!1&&!(i&&i.getMeta("addToHistory")===!1)){let a=t.getMeta("composition"),l=n.prevTime==0||!i&&n.prevComposition!=a&&(n.prevTime<(t.time||0)-r.newGroupDelay||!Fi(t,n.prevRanges)),u=i?Qe(n.prevRanges,t.mapping):cn(t.mapping.maps);return new ce(n.done.addTransform(t,l?e.selection.getBookmark():void 0,r,He(e)),re.empty,u,t.time,a??n.prevComposition)}else return(s=t.getMeta("rebased"))?new ce(n.done.rebased(t,s),n.undone.rebased(t,s),Qe(n.prevRanges,t.mapping),n.prevTime,n.prevComposition):new ce(n.done.addMaps(t.mapping.maps),n.undone.addMaps(t.mapping.maps),Qe(n.prevRanges,t.mapping),n.prevTime,n.prevComposition)}function Fi(n,e){if(!e)return!1;if(!n.docChanged)return!0;let t=!1;return n.mapping.maps[0].forEach((r,o)=>{for(let s=0;s<e.length;s+=2)r<=e[s+1]&&o>=e[s]&&(t=!0)}),t}function cn(n){let e=[];for(let t=n.length-1;t>=0&&e.length==0;t--)n[t].forEach((r,o,s,i)=>e.push(s,i));return e}function Qe(n,e){if(!n)return null;let t=[];for(let r=0;r<n.length;r+=2){let o=e.map(n[r],1),s=e.map(n[r+1],-1);o<=s&&t.push(o,s)}return t}function $i(n,e,t){let r=He(e),o=me.get(e).spec.config,s=(t?n.undone:n.done).popEvent(e,r);if(!s)return null;let i=s.selection.resolve(s.transform.doc),a=(t?n.done:n.undone).addTransform(s.transform,e.selection.getBookmark(),o,r),l=new ce(t?a:s.remaining,t?s.remaining:a,null,0,-1);return s.transform.setSelection(i).setMeta(me,{redo:t,historyState:l})}let et=!1,un=null;function He(n){let e=n.plugins;if(un!=e){et=!1,un=e;for(let t=0;t<e.length;t++)if(e[t].spec.historyPreserveItems){et=!0;break}}return et}const me=new te("history"),Ui=new te("closeHistory");function tt(n={},e=void 0){return n={depth:n.depth||100,newGroupDelay:n.newGroupDelay||500},new ee({key:me,state:{init(){return e??new ce(re.empty,re.empty,null,0,-1)},apply(t,r,o){return zi(r,o,t,n)}},config:n,props:{handleDOMEvents:{beforeinput(t,r){let o=r.inputType,s=o=="historyUndo"?tr:o=="historyRedo"?dt:null;return!s||!t.editable?!1:(r.preventDefault(),s(t.state,t.dispatch))}}}})}function er(n,e){return(t,r)=>{let o=me.getState(t);if(!o||(n?o.undone:o.done).eventCount==0)return!1;if(r){let s=$i(o,t,n);s&&r(e?s.scrollIntoView():s)}return!0}}const tr=er(!1,!0),dt=er(!0,!0);function nr(n,e){const t=e&&n.dom?.querySelectorAll(`[data-edit-id="${e}"]`);return t?Array.from(t):[]}function Wi(n,e){return nr(n,e).flatMap(r=>Array.from(r.getClientRects()))}function pt(n,e,t){return n>=t.left&&n<=t.right&&e>=t.top&&e<=t.bottom}function rr(n){const e=Math.min(...n.map(s=>s.left)),t=Math.max(...n.map(s=>s.right)),r=Math.min(...n.map(s=>s.top)),o=Math.max(...n.map(s=>s.bottom));return{left:e,right:t,top:r,bottom:o}}function Ki(n,e,t){return t.some(o=>pt(n,e,o))?!0:t.length<2?!1:t.some(o=>n>=o.left&&n<=o.right&&e>o.bottom)&&t.some(o=>n>=o.left&&n<=o.right&&e<o.top)}const Gi=new te("linkTooltip"),Xi=36;class Yi{tooltipElement;button;onMouseLeave;constructor(e){this.tooltipElement=document.createElement("div"),this.tooltipElement.className=J("absolute  py-1.5 px-2.5 bg-token-main-surface-primary border border-token-border-light rounded-lg text-xs z-50 items-center cursor-pointer shadow-md flex justify-center cursor-pointer","transform -translate-x-1/2"),this.button=document.createElement("button"),this.button.textContent="Open link",this.button.className=J("bg-none","border-none","text-token-text-primary ","text-sm"),this.tooltipElement.appendChild(this.button),this.onMouseLeave=e,this.tooltipElement.addEventListener("mouseleave",e)}show(e,t,r){document.body.appendChild(this.tooltipElement),this.tooltipElement.style.left=`${e}px`,this.tooltipElement.style.top=`${t}px`;const o=()=>{window.open(r,"_blank"),this.hide()};this.button.addEventListener("click",o,{once:!0})}hide(){this.tooltipElement.parentNode&&this.tooltipElement.parentNode.removeChild(this.tooltipElement)}}function Zi(){let n=null,e=null;const t=s=>{if(n==null||e==null)return!1;const i=Array.from(e.getClientRects()),a=n.tooltipElement.getBoundingClientRect();if(i.length===1){const l=i[0];return!pt(s.clientX,s.clientY,rr([l,a]))}else return!Ki(s.clientX,s.clientY,[a,...i])},r=(s,i)=>{n&&(n.hide(),n=null);const a=s.getAttribute("href");if(!a)return;const l=Array.from(s.getClientRects()),u=l.find(f=>pt(i.clientX,i.clientY,f))??l[0],c=u.left+u.width/2,d=u.top-Xi;n=new Yi(f=>{t(f)&&o()}),n.show(c,d,a),e=s},o=()=>{n&&(n.hide(),n=null),e=null};return new ee({key:Gi,props:{handleDOMEvents:{mousemove(s,i){const a=()=>{const{target:u}=i;if(!(u instanceof HTMLElement))return!1;const c=u.closest("a[href]");return c!=null&&c!==e?(r(c,i),!0):!1},l=()=>{n==null||!t(i)||o()};a()||l()}}},view:()=>({destroy:o})})}function or(n){return he().serialize(n).length}const qi=new te("maxLength"),Ji=(n,e,t)=>new ee({key:qi,state:{init(){return t},apply:()=>{}},filterTransaction(r){if(n==null||!r.steps.some(i=>i instanceof wo||i instanceof Se?i.slice.size>i.to-i.from:!1))return!0;const s=or(r.doc);return s<=t?!0:(e&&yt(e,n),B.logEvent(le.canvasProsemirrorMaxLength,{maxLength:t,newLength:s}),!1)}});function Qi(n,e){const{state:t}=n,{selection:r}=t,o=r.content(),{schema:s}=t,i=s.topNodeType.create(null,o.content),a=ea(i,n),l=t.doc.textBetween(r.from,r.to,`
`);e.clipboardData?.setData("application/x-prosemirror",l),e.clipboardData?.setData("text/plain",a),e.preventDefault()}function ea(n,e){let t="";function r(o){if(o.type.name==="paragraph")return o.content.forEach(s=>{r(s)}),t+=`
`,!1;if(o.type.name==="contentReference"){const s=o.attrs.index,i=ta(s,e);return i&&(t+=`[${i}]`),!1}else o.isText&&o.text!==void 0&&(t+=o.text);return!0}return n.descendants(r),t.endsWith(`
`)&&(t=t.slice(0,-1)),t}function ta(n,e){const t=Pn.getState(e.state),r=parseInt(n);if(t==null||r==null)return null;const o=t?.displayedContentReferences?.[r];return o==null||o.type!=="grouped_webpages"?null:o.items?.[0]?.url}class na{dom;node;view;getPos;key;collectReactElement;constructor(e,t,r,o){this.node=e,this.getPos=r,this.view=t,this.dom=document.createElement("span"),this.dom.className="content-reference-node";const s=()=>`${gr()}`;this.key=`content-reference-node-${s()}`,this.collectReactElement=o,this.renderReactComponent()}renderReactComponent(){const{index:e}=this.node.attrs,t=Pn.getState(this.view.state);if(e==null)return;const r=t?.displayedContentReferences?.[e];if(!r||r.type!=="grouped_webpages")return;const o=g.jsx(Zo,{webpageRef:r,trackContentReferenceEvent:()=>{},isSearchResponse:!1,disableEnhancedAttributionFlag:!0}),s=mr.createPortal(o,this.dom);this.collectReactElement(this.key,s)}update(e){return e.attrs!==this.node.attrs&&(this.node=e,this.renderReactComponent()),!0}destroy(){this.collectReactElement(this.key,null)}}function ra(n={}){return new ee({view(e){return new oa(e,n)}})}class oa{constructor(e,t){var r;this.editorView=e,this.cursorPos=null,this.element=null,this.timeout=-1,this.width=(r=t.width)!==null&&r!==void 0?r:1,this.color=t.color===!1?void 0:t.color||"black",this.class=t.class,this.handlers=["dragover","dragend","drop","dragleave"].map(o=>{let s=i=>{this[o](i)};return e.dom.addEventListener(o,s),{name:o,handler:s}})}destroy(){this.handlers.forEach(({name:e,handler:t})=>this.editorView.dom.removeEventListener(e,t))}update(e,t){this.cursorPos!=null&&t.doc!=e.state.doc&&(this.cursorPos>e.state.doc.content.size?this.setCursor(null):this.updateOverlay())}setCursor(e){e!=this.cursorPos&&(this.cursorPos=e,e==null?(this.element.parentNode.removeChild(this.element),this.element=null):this.updateOverlay())}updateOverlay(){let e=this.editorView.state.doc.resolve(this.cursorPos),t=!e.parent.inlineContent,r;if(t){let a=e.nodeBefore,l=e.nodeAfter;if(a||l){let u=this.editorView.nodeDOM(this.cursorPos-(a?a.nodeSize:0));if(u){let c=u.getBoundingClientRect(),d=a?c.bottom:c.top;a&&l&&(d=(d+this.editorView.nodeDOM(this.cursorPos).getBoundingClientRect().top)/2),r={left:c.left,right:c.right,top:d-this.width/2,bottom:d+this.width/2}}}}if(!r){let a=this.editorView.coordsAtPos(this.cursorPos);r={left:a.left-this.width/2,right:a.left+this.width/2,top:a.top,bottom:a.bottom}}let o=this.editorView.dom.offsetParent;this.element||(this.element=o.appendChild(document.createElement("div")),this.class&&(this.element.className=this.class),this.element.style.cssText="position: absolute; z-index: 50; pointer-events: none;",this.color&&(this.element.style.backgroundColor=this.color)),this.element.classList.toggle("prosemirror-dropcursor-block",t),this.element.classList.toggle("prosemirror-dropcursor-inline",!t);let s,i;if(!o||o==document.body&&getComputedStyle(o).position=="static")s=-pageXOffset,i=-pageYOffset;else{let a=o.getBoundingClientRect();s=a.left-o.scrollLeft,i=a.top-o.scrollTop}this.element.style.left=r.left-s+"px",this.element.style.top=r.top-i+"px",this.element.style.width=r.right-r.left+"px",this.element.style.height=r.bottom-r.top+"px"}scheduleRemoval(e){clearTimeout(this.timeout),this.timeout=setTimeout(()=>this.setCursor(null),e)}dragover(e){if(!this.editorView.editable)return;let t=this.editorView.posAtCoords({left:e.clientX,top:e.clientY}),r=t&&t.inside>=0&&this.editorView.state.doc.nodeAt(t.inside),o=r&&r.type.spec.disableDropCursor,s=typeof o=="function"?o(this.editorView,t,e):o;if(t&&!s){let i=t.pos;if(this.editorView.dragging&&this.editorView.dragging.slice){let a=No(this.editorView.state.doc,i,this.editorView.dragging.slice);a!=null&&(i=a)}this.setCursor(i),this.scheduleRemoval(5e3)}}dragend(){this.scheduleRemoval(20)}drop(){this.scheduleRemoval(20)}dragleave(e){(e.target==this.editorView.dom||!this.editorView.dom.contains(e.relatedTarget))&&this.setCursor(null)}}function Be(n){return(e,t,r)=>{const{doc:o,selection:s}=e,{empty:i,$head:a}=s;if(i&&r?.endOfTextblock(n)){const l=n==="left"||n==="up"?-1:1,u=Mt.near(o.resolve(l>0?a.after():a.before()),l);if(u.$head?.parent.type.name===Ge)return t?.(e.tr.setSelection(u)),!0}return!1}}const sa=Nt({ArrowLeft:Be("left"),ArrowRight:Be("right"),ArrowUp:Be("up"),ArrowDown:Be("down")}),We=new te("modelCursor");function ia(n,e){return n.setMeta(We,{modelCursor:e})}function aa(n){return n.getMeta(We)??null}const dn=(n,e)=>{const{doc:t}=n,r=[];if(!e)return Y.empty;const{modelSelectionPositionRange:o,modelCursorPosition:s}=e,{sourceRangeToPmRange:i,sourceEndToPmPos:a}=Ve(t);if(s!=null){const l=qe(s,a(s),"min");if(l==null)return Y.empty;if(l!=null&&ze(t,l)){const u=t.resolve(l);if(t.nodeAt(l)?.type.name===ut.proseMirrorNodeName()||u.nodeBefore?.type.name===ut.proseMirrorNodeName())return Y.empty}r.push(ye.widget(l,()=>{const u=document.createElement("span");return u.className=Br.modelCursor,u},{ignoreSelection:!0,side:1}))}else if(o!=null){const{start:l,end:u}=i(o),c=qe(o.start,l,"max"),d=qe(o.end,u,"min");if(c==null||d==null)return Y.empty;r.push(ye.inline(c,d,{class:`${Ro} !bg-[Highlight]`}))}return r.length?Y.create(t,r):Y.empty},la=(n,e)=>{let r=n.domAtPos(e)?.node;if(r===n.dom)return null;for(;r&&!(r instanceof HTMLElement);)r=r.parentNode;return r},ca=(n,e)=>{la(n,e.to)?.scrollIntoView({behavior:"smooth",block:"center"})},ua=(n,e)=>{if(n&&!e)return!0;const t=n?.modelSelectionPositionRange?.start,r=e?.modelSelectionPositionRange?.start;return t!==void 0&&(r===void 0||t!==r)};function pn(n=void 0,e=void 0){return new ee({key:We,state:{init:(t,r)=>({modelCursor:n,deco:dn(r,n),isNewCursor:!1,isCursorActive:e?.isCursorActive??!1}),apply:(t,r,o,s)=>{const a=aa(t)?.modelCursor??r.modelCursor,l=dn(s,a),u=!!((!r.isCursorActive||ua(a,r.modelCursor))&&l&&l.find()[0]),c=!!a&&(u||r.isCursorActive);return{modelCursor:a,deco:l,isNewCursor:u,isCursorActive:c}}},props:{decorations(t){return this.getState(t)?.deco}},view(t){return{update(r){const{deco:o,isNewCursor:s}=We.getState(r.state),i=o&&o.find()[0];i&&s&&ca(r,i)}}}})}const sr="ignoreDocChange";function da(n){return n.setMeta(sr,!0)}function pa(n){return n.getMeta(sr)===!0}function fa(n){const e=n.content.size-(n.lastChild?.content.size??0)-1;if(ze(n,e))return Z.create(n,e)}const ir=({intl:n,toaster:e,value:t,comments:r,diff:o,maxLength:s=Vn,selection:i,onFocus:a,onBlur:l,onSave:u,safeUrls:c,modelCursor:d,isDisabled:f,prevState:h,contentRefereces:p,shouldUseContentReferencePlugin:m})=>{const M=he(),x=M.schema();let y=t;s!=null&&y.length>s&&(y=y.slice(0,s),e!=null&&n!=null&&yt(e,n,s));let N,E=[],T=[];o&&o.edits.length>0?{doc:N,addedRanges:E,deletedRanges:T}=Bi({diff:o}):N=M.parse(y);const A=i?Us(N,i):fa(N),S=()=>{const P=h?.plugins.find(D=>D.spec.key===tt().spec.key);return P==null||h==null?tt():tt({},P.getState(h))},R=P=>{const D=h?.plugins.find(w=>w.spec.key===pn().spec.key),v=h&&D?.getState(h);return pn(P,v)};return Rn.create({doc:N,schema:x,selection:A,plugins:[...m?[ko(p)]:[],Ji(n,e,s),M.inputRulesPlugin(),M.keymapPlugin(),Nt({"Mod-s":()=>(u(),!0),"Mod-z":tr,"Mod-shift-z":dt,"Mod-y":dt}),sa,ra(),xo(),S(),Li(a,l),yn(r??[]),...o?[Bs(E,T)]:[],R(d),Ss(new Set(c??[])),As(n,f),Zi(),...js()]})},ar=(n,e)=>{const t=he(),r=t.schema(),o=t.parse(n);return Rn.create({doc:o,schema:r,plugins:[yn(e??[])]})},ha=({mount:n,value:e,comments:t,isDarkMode:r})=>new An({mount:n},{editable:()=>!1,state:ar(e,t),nodeViews:{[Ge]:(s,i,a)=>new bt(s,i,a,r)}}),ma=(n,{intl:e,toaster:t,comments:r,value:o,maxLength:s=Vn,onBlur:i,onFocus:a,onChange:l,onUpdate:u,onSave:c,safeUrls:d,modelCursor:f,selection:h,isDisabled:p,diff:m,prevState:M,contentRefereces:x,collectReactElement:y},N=!1)=>{const E=wt(),T=ir({intl:e,toaster:t,comments:r,value:o,maxLength:s,onBlur:i,onFocus:a,onSave:c,safeUrls:d,modelCursor:f,selection:h,isDisabled:p,diff:m,prevState:M,contentRefereces:x,collectReactElement:y,shouldUseContentReferencePlugin:E});u(T);const A=v=>{const w=D.state.apply(v);if(D.updateState(w),u(w),!v.docChanged||pa(v))return;const b=$n(w);if(!b)return;const{doc:V}=w,{changeset:H}=b;l?.({transaction:v,changeset:H,doc:V,getSerializedDocument:()=>he().serialize(V),getAdjustedComments:()=>{const L=Lr(Cn,w);if(L==null)return[];const K=he(),_=K.parse(K.serialize(V)),j=Xr(_,L.positions);return Yr(L.comments,j)}})},S=he(),P={...S.nodeViews(),...E?{[be]:(v,w,b)=>new na(v,w,b,y)}:{},...m!=null?{}:{[Ge]:(v,w,b)=>new bt(v,w,b,N)}},D=new An({mount:n},{state:T,editable:()=>!p,dispatchTransaction:A,nodeViews:P,...E?{handleDOMEvents:{copy:(v,w)=>Qi(v,w)}}:{},handlePaste(v,w){let b;if(E&&(b=w.clipboardData?.getData("application/x-prosemirror")),(b==null||b==="")&&(b=w.clipboardData?.getData("text/plain")),b==null)return!1;B.logEvent(le.canvasProsemirrorPaste,{textLength:b.length});const V=or(v.state.doc),H=V+b.length;let L=b;if(s!=null&&H>s){t!=null&&e!=null&&yt(t,e,s);const _=s-V-50;L=_>0?b.slice(0,_):""}return yo(v,L,E),!0}});return{view:D,pmu:S}},ga="_main_5jn6z_1",lr={main:ga};function Ma(n,e){const t=e.target;if(t instanceof Element&&[ge.PROSEMIRROR_EDITOR_CONTAINER,ge.PROSEMIRROR_CONTEXT_CHILDREN].some(l=>t.closest(`#${l}`)!=null))return!1;n.focus();const r=zs(n.dom.getBoundingClientRect(),{x:e.clientX,y:e.clientY}),o=n.state.tr,s=n.posAtCoords({left:r.x,top:r.y});if(s!=null){const i=Math.min(s.pos,Vr(n.state.doc)-1);o.setSelection(new Z(o.doc.resolve(i))),n.dispatch(o)}return!0}const ve=({editorRef:n,wrapperClassName:e,transparentBackground:t=!1,comments:r,commentingOn:o,diff:s,paddingBottom:i,hoveredCommentId:a,focusedCommentId:l,hoveredEditId:u,rejectedEdits:c,showChanges:d,isDisabled:f=!1,value:h,onBlur:p,onFocus:m,onChange:M,onMouseLeave:x,onSave:y,safeUrls:N,children:E,width:T,modelCursor:A,shouldResetSelection:S=!1,contentRefereces:R})=>{const P=ft(),D=Eo(),v=k.useRef(null),w=k.useRef(null),[b,V]=k.useState(null),H=Dn(),L=bo(),[{width:K},_]=Hn(),j=k.useRef(p);j.current=p;const $=k.useRef(m);$.current=m;const I=k.useRef(M);I.current=M;const U=k.useRef(y);U.current=y;const Q=wt(),[ie,ue]=k.useState(()=>new Map),Ee=k.useCallback((C,O)=>{ue(G=>{const X=new Map(G);return O==null?X.delete(C):X.set(C,O),X})},[]),Ae=k.useCallback((C=h)=>ir({intl:P,toaster:D,comments:r,diff:s,value:C,selection:S?void 0:w.current?.state.selection,onBlur:O=>j.current?.(O),onFocus:O=>$.current?.(O),onSave:()=>U.current?.(),modelCursor:A,isDisabled:f,safeUrls:N,prevState:b,contentRefereces:R,collectReactElement:Ee,shouldUseContentReferencePlugin:Q}),[P,D,r,s,h,S,A,f,N,b,R,Ee,Q]),Ie=k.useCallback(C=>{const O=Ae(C);w.current?.updateState(O),V(O)},[Ae]);k.useImperativeHandle(n,()=>({UNSAFE_setValue:Ie,revertChanges:()=>{if(w.current==null)throw new Error("Tried to call revertChanges, but viewRef.current is null");Hs(w.current)},flushChanges:()=>{if(w.current==null)throw new Error("Tried to call flushChanges, but viewRef.current is null");Vs(w.current)},maybeFocusOnEditor:C=>{if(w.current==null)throw new Error("Tried to call maybeFocus, but viewRef.current is null");return Ma(w.current,C)},viewRef:w})),_n(()=>{const{current:C}=v;if(!C)return;const{view:O}=ma(C,{intl:P,toaster:D,comments:r,diff:s,value:h,onBlur:G=>j.current?.(G),onFocus:G=>$.current?.(G),onChange:G=>I.current?.(G),onUpdate:V,onSave:()=>U.current?.(),isDisabled:f,safeUrls:N,prevState:b,contentRefereces:R,collectReactElement:Ee,shouldUseContentReferencePlugin:Q},H);return w.current=O,()=>{O?.destroy()}},[s]),k.useEffect(()=>{w.current?.setProps({editable:()=>!f})},[f]),fe(C=>Ps(C,f),w,[f]),fe(C=>{if(!L)return;const{schema:O}=C.doc.type,G=O.nodes.code_block;return G?(C.doc.descendants((X,Oe)=>{if(X.type===G){const Xe=X.type.create({...X.attrs,isDarkMode:H},X.content,X.marks);C.replaceWith(Oe,Oe+X.nodeSize,Xe)}}),da(C)):C},w,[L,H]),fe(C=>C.setMeta(ct,d),w,[d]),fe(C=>ia(C,A),w,[A]),fe(C=>C.setMeta(Cn,{comments:r,commentingOn:o,hoveredCommentId:a,focusedCommentId:l}),w,[r,a,l,o]),fe(C=>C.setMeta(lt,{hoveredEditId:u,rejectedEdits:c??new Set}),w,[u,c]),fe(C=>vs(C,new Set(N??[])),w,[N]);const St=k.useCallback(()=>w.current,[w]),Me=[],we=[];return k.Children.forEach(E,C=>{if(!k.isValidElement(C))return;const{type:O}=C;if(O===ur)Me.push(C);else if(O===cr)we.push(C);else throw new Error("Invalid Prosemirror child: "+JSON.stringify(O))}),g.jsx(Zr.Provider,{value:St,children:g.jsx(qr.Provider,{value:b,children:g.jsxs(Jr.Provider,{value:K,children:[g.jsx("div",{id:ge.PROSEMIRROR_CONTEXT_CHILDREN,children:Me}),g.jsxs("div",{className:e,onMouseLeave:x,id:ge.PROSEMIRROR_EDITOR_CONTAINER,style:{paddingBottom:i},children:[g.jsx("div",{ref:Ct(v,_),className:J(lr.main,Bn.composer,"markdown prose contain-inline-size dark:prose-invert focus:outline-none",t?"bg-transparent":"bg-token-main-surface-primary"),style:{width:T}}),we,Q?Array.from(ie.values()):null]})]})})})},cr=({children:n})=>n,ur=({children:n})=>n;ve.EditorChildren=cr;ve.ContextChildren=ur;function wa(n,e){k.useEffect(()=>{const t=n?.current;if(t!=null)return vo(t,{mousedown:r=>{e.current?.maybeFocusOnEditor(r)===!0&&r.preventDefault()}})},[e,n])}const Na=({wrapperClassName:n,value:e="",width:t,comments:r,paddingBottom:o})=>{const s=k.useRef(null),i=k.useRef(null),a=Dn();return k.useEffect(()=>{const{current:l}=s;if(l)return i.current=ha({mount:l,comments:r,value:e,isDarkMode:a}),()=>{i.current?.destroy()}},[]),k.useEffect(()=>{const l=ar(e,r);i.current?.updateState(l)},[e,r]),g.jsx("div",{className:n,children:g.jsx("div",{ref:Ct(s),className:J(lr.main,"markdown prose dark:prose-invert focus:outline-none"),style:{width:t,paddingBottom:o}})})},dr=n=>!n||"docView"in n&&n.docView==null||Hr(n.state.doc),Le=100,ka={type:"spring",duration:1.5,bounce:.1},xa={type:"spring",duration:.5,bounce:0},fn={type:"spring",duration:.2},hn={type:"spring",duration:1,delay:.1},ya={type:"spring",duration:1},Ca={type:"spring",duration:.5,bounce:0},Ea=({isRewriting:n=!1,value:e,previousValue:t,previousComments:r,documentWidth:o,paddingBottom:s,onStart:i})=>{const a=gt(),l=At(0),u=At(-Le),c=k.useRef(!1),[d,f]=Mr();_n(()=>{const p=a();return p&&(p.dom.style.clipPath="inset(0 0 100% 0)"),()=>{const m=a();m&&(m.dom.style.clipPath="")}},[]),k.useEffect(()=>{const p=a();if(!p||dr(p))return d?void 0:f?.();try{const m=Qr(p.state.doc)?.end;if(m==null||m>e.length)return;const{top:M}=p.coordsAtPos(0),{top:x,bottom:y}=p.coordsAtPos(Math.max(p.state.doc.content.size-1,0),-1),N=y-M,E=x-M;if(l.set(N-E),!d){It(u,N+2*l.get(),xa).then(()=>f?.());return}It(u,N,ka)}catch(m){B.logError("Failed to set rewrite animation position",m),f?.()}},[d,e]);const h=wr(u,p=>at(p)-Le+2);return Ot(u,"change",p=>{const m=a();!m||!p||!c.current||(m.dom.style.clipPath=`inset(0 0 calc(100% - ${p}px) 0)`)}),Ot(u,"animationStart",()=>{n&&i?.()}),g.jsxs(g.Fragment,{children:[g.jsx(xe.div,{className:"absolute top-0 z-10 w-full origin-bottom bg-gradient-to-t from-token-main-surface-primary from-10% to-transparent",style:{translateY:h,height:Le},initial:{opacity:0},animate:{opacity:1,transition:fn},exit:{opacity:0,transition:hn},onAnimationComplete:()=>c.current=!0},"wash-top"),g.jsx(xe.div,{className:"absolute top-0 z-10 w-full bg-gradient-to-b from-token-main-surface-primary to-transparent",style:{translateY:u,height:Le},initial:{opacity:0},animate:{opacity:1,transition:fn},exit:{opacity:0,transition:hn}},"wash-bottom"),g.jsx(xe.div,{className:"pointer-events-none absolute z-0 min-w-0 max-w-full",initial:{opacity:1},animate:{opacity:.3,transition:ya},exit:{opacity:0,transition:Ca},children:g.jsx(Na,{value:t,width:o,comments:r,wrapperClassName:"h-fit flex",paddingBottom:s})},"previousValue")]})},ba=n=>k.createElement("svg",{width:16,height:17,viewBox:"0 0 16 17",fill:"none",xmlns:"http://www.w3.org/2000/svg",...n},k.createElement("path",{d:"M5.11619 13.8334C4.41395 13.8334 4 13.4047 4 12.6655V4.32729C4 3.59548 4.41395 3.16675 5.11619 3.16675H8.64218C10.6454 3.16675 11.9021 4.19424 11.9021 5.82787C11.9021 6.99581 11.0298 7.97155 9.89882 8.14157V8.20071C11.3477 8.31158 12.4121 9.36864 12.4121 10.7805C12.4121 12.6581 11.0002 13.8334 8.72349 13.8334H5.11619ZM6.23239 7.60195H7.83645C9.02657 7.60195 9.70663 7.07712 9.70663 6.1753C9.70663 5.31782 9.10788 4.82995 8.0656 4.82995H6.23239V7.60195ZM6.23239 12.1702H8.15431C9.44052 12.1702 10.1354 11.6232 10.1354 10.6031C10.1354 9.60519 9.41834 9.07296 8.10256 9.07296H6.23239V12.1702Z",fill:"currentColor"})),va=n=>k.createElement("svg",{width:16,height:17,viewBox:"0 0 16 17",fill:"none",xmlns:"http://www.w3.org/2000/svg",...n},k.createElement("path",{d:"M9.94587 13.3511C9.89814 13.6297 9.6566 13.8334 9.37393 13.8334H4.95078C4.59259 13.8334 4.31994 13.5121 4.37824 13.1587C4.42447 12.8785 4.66675 12.6729 4.95077 12.6729H6.60855L8.09599 4.32729H6.62967C6.27148 4.32729 5.99883 4.00598 6.05714 3.65257C6.10337 3.37234 6.34565 3.16675 6.62967 3.16675H11.054C11.4108 3.16675 11.683 3.4856 11.6271 3.83793C11.5824 4.11979 11.3394 4.32729 11.054 4.32729H9.39198L7.90454 12.6729H9.37393C9.73357 12.6729 10.0066 12.9967 9.94587 13.3511Z",fill:"currentColor"}));function mn(n,e){if(n==null)return!1;const t=n.state.schema.marks[e];return t==null?!1:Wn(n.state,n.dispatch,t)}function nt(n,e){if(n==null)return!1;const{state:t,dispatch:r}=n,o=Re(t.schema.nodes[xn.proseMirrorNodeName()]);return In(o,{level:e})(t,r)}function Ta(n){if(n==null)return!1;const{state:e,dispatch:t}=n,r=Re(e.schema.nodes[kn.proseMirrorNodeName()]);return In(r)(e,t)}const Sa=({availableWidth:n,onAddComment:e,isSendDisabled:t=!1,isWaitingForCommentResponse:r=!1,onSubmitAccelerator:o})=>{const s=ft(),i=gt(),a=En(),l=es(),u=k.useCallback(p=>{const{width:m,height:M}=p,x=i();if(!a||!x||dr(x))return null;const{to:y,empty:N,head:E}=a.selection,{platform:T}=Fo(),A=T==="web"?E:y,S=A===y;if(N||!ze(x.state.doc,A))return null;const{right:R,left:P,top:D}=x.coordsAtPos(0);let v=A,w=x.state.doc.nodeAt(v);const b=S?-1:1;for(;!w?.isText&&ze(x.state.doc,v+b);)v+=b,w=x.state.doc.nodeAt(v);const{left:V,bottom:H,top:L}=x.coordsAtPos(v,S?-1:1),K=R-P;function _(){if(S)return Math.max(V-P-m,0);let I=V-P;return I+m>K&&(I=-(m-K)),I}function j(){const I=window.innerHeight-H>M*2;return S&&I?{top:H-D+8,aboveOrBelow:_t.BELOW}:{top:L-D-M-8,aboveOrBelow:_t.ABOVE}}const $=j();return{left:_(),top:$.top,aboveOrBelow:$.aboveOrBelow,toolbarSize:p}},[a,i]),c=k.useCallback(()=>i()?.dom??null,[i]),d=[{label:s.formatMessage(ae.heading1),className:"text-5xl font-semibold",onClick:()=>{B.logButtonClick(de.TOOLBAR_FORMAT_HEADER1),nt(i(),1)}},{label:s.formatMessage(ae.heading2),className:"text-3xl font-semibold",onClick:()=>{B.logButtonClick(de.TOOLBAR_FORMAT_HEADER2),nt(i(),2)}},{label:s.formatMessage(ae.heading3),className:"text-2xl font-semibold",onClick:()=>{B.logButtonClick(de.TOOLBAR_FORMAT_HEADER3),nt(i(),3)}},{label:s.formatMessage(ae.body),className:"text-base",onClick:()=>{B.logButtonClick(de.TOOLBAR_FORMAT_PARAGRAPH),Ta(i())}}],f=()=>{const p=i();if(!p)return null;const{state:m}=p,{from:M,to:x,sourceFrom:y,sourceTo:N}=ro(m);return M==null||x==null||y==null||N==null?(B.logError("Prosemirror getSelectionRange has null values",null,{from:M,to:x,sourceFrom:y,sourceTo:N}),null):{from:M,to:x,sourceFrom:y,sourceTo:N}},h=(p,m)=>{const M=i(),x=f();if(x==null)return;const{sourceFrom:y,sourceTo:N}=x,E={start:y,end:N};if(a&&M){const T=a.tr.setSelection(Z.create(a.doc,a.selection.anchor));M.dispatch(T)}B.logButtonClick(de.TOOLBAR_FORMAT_STYLE,{action:{action:m.action,id:m.id,title:m.title},prompt:p,sourceFrom:y,sourceTo:N}),o?.(E,s.formatMessage(p),m)};return g.jsxs(jr,{isWaitingForCommentResponse:r,isSendDisabled:t,onAddComment:e,toolbarType:zr.WRITING,getToolbarPosition:u,getEditorDom:c,getSelectionRange:f,children:[l&&g.jsxs(g.Fragment,{children:[g.jsx(Ne.Separator,{}),g.jsx(Ne.Popover,{label:s.formatMessage(ae.format),hideLabel:n<=400,icon:eo,align:"center",children:g.jsx("div",{className:J("flex w-48 flex-col items-stretch rounded-xl border border-token-border-light bg-token-main-surface-primary p-1",zt),children:to.map(p=>{const{title:m,icon:M}=p;return g.jsxs("button",{onClick:()=>{"prompt"in p&&h(p.prompt,p)},className:"flex flex-row items-center gap-x-2 rounded-md bg-token-main-surface-primary p-3 hover:bg-[#f5f5f5] dark:hover:bg-token-main-surface-secondary",children:[g.jsx("div",{className:"flex",children:g.jsx(M,{className:"icon-md"})}),g.jsx("div",{className:"line-clamp-1 flex-auto text-start text-sm",children:s.formatMessage(m)})]},p.id)})})})]}),g.jsx(Ne.Separator,{}),g.jsx(Ne.Action,{label:s.formatMessage(ae.bold),hideLabel:!0,icon:ba,onClick:()=>{B.logButtonClick(de.TOOLBAR_FORMAT_BOLD),mn(i(),Kn.proseMirrorMarkName())},onMouseDown:p=>p.preventDefault()}),g.jsx(Ne.Action,{label:s.formatMessage(ae.italic),hideLabel:!0,icon:va,onClick:()=>{B.logButtonClick(de.TOOLBAR_FORMAT_ITALIC),mn(i(),Yn.proseMirrorMarkName())},onMouseDown:p=>p.preventDefault()}),g.jsx(Ne.Popover,{label:s.formatMessage(ae.format),hideLabel:!0,icon:no,children:g.jsx("div",{className:J("flex flex-col items-stretch rounded-xl border border-token-border-light bg-token-main-surface-primary p-1",zt),children:d.map(({label:p,className:m,onClick:M})=>g.jsx("button",{onClick:M,className:"w-full rounded-xl p-4 text-start hover:bg-token-main-surface-secondary",children:g.jsx("div",{className:m,children:p})},p))})})]})},ae=kt({bold:{id:"qqbk91",defaultMessage:"Bold"},italic:{id:"5oh4LV",defaultMessage:"Italic"},format:{id:"z8IGv0",defaultMessage:"Transform"},heading1:{id:"AR5o30",defaultMessage:"Heading 1"},heading2:{id:"zb/wrc",defaultMessage:"Heading 2"},heading3:{id:"xZJvLM",defaultMessage:"Heading 3"},body:{id:"Hi6z3L",defaultMessage:"Body"},caption:{id:"VXpL7v",defaultMessage:"Caption"},bullets:{id:"2vznKX",defaultMessage:"Bullets"},outline:{id:"Xmbt6r",defaultMessage:"Outline"},table:{id:"0UjL6P",defaultMessage:"Table"}});function gn({position:n,numEdits:e,closestEditId:t}){const r=bn(),o=ft(),s=n==="top"?$o:Uo,i=()=>{const l=r();if(!l||!t)return;const u=nr(l,t);if(u.length===0){xt.addError("Edit could not be found while attempting to scroll",{closestEditId:t});return}u[n==="top"?0:u.length-1].scrollIntoView({behavior:"smooth",block:"center"})},a=n==="top"?-4:4;return g.jsx(je,{children:e>0&&g.jsx(xe.div,{className:J("absolute left-1/2 z-20 select-none",{"bottom-[20px]":n==="bottom","top-[20px]":n==="top"}),initial:{scale:.95,translateY:a,translateX:"-50%",opacity:0},animate:{scale:1,translateY:0,translateX:"-50%",opacity:1},exit:{scale:.95,translateY:a,translateX:"-50%",opacity:0},transition:{type:"spring",duration:.3},children:g.jsxs("div",{className:J("flex items-center justify-center rounded-full border px-4 py-2","border-token-main-surface-tertiary bg-token-main-surface-primary shadow-md hover:bg-token-main-surface-secondary"),"aria-label":o.formatMessage(Mn.ariaLabel),role:"button",onClick:i,children:[g.jsx(Nr,{...Mn.label,values:{count:e}}),g.jsx(s,{className:"icon-sm ml-2"})]})})})}const Mn=kt({label:{id:"Pf30w4",defaultMessage:"{count, plural, one {1 more edit} other {{count} more edits}}"},ariaLabel:{id:"qTJjzl",defaultMessage:"Button to scroll the next edit into view."}});function Pa({diff:n=null}){const e=bn(),[t,r]=k.useState([]),[o,s]=k.useState([]),i=it.useState(it.selectWindowHeight),a=k.useCallback(()=>{const l=e();if(!l||!n)return;const u=[],c=[];for(const d of n.edits){const f=Wi(l,d.id);if(f.length>0){const h=rr(f);h.bottom<0?u.push([d.id,h]):h.top>i&&c.push([d.id,h])}}u.sort(([,d],[,f])=>d.bottom-f.bottom),c.sort(([,d],[,f])=>d.top-f.top),r(u.map(([d])=>d)),s(c.map(([d])=>d))},[n,i,e]);return Fr(n?.edits??[],a),k.useEffect(()=>{const l=setTimeout(a,500);return()=>{clearTimeout(l)}},[a]),g.jsxs(g.Fragment,{children:[g.jsx(gn,{position:"top",numEdits:t.length,closestEditId:t[t.length-1]}),g.jsx(gn,{position:"bottom",numEdits:o.length,closestEditId:o[0]})]})}const wn=To(()=>({rejectedEdits:new Set,hoveredEditId:null})),Ra=({pos:n})=>{const e=gt()(),t=En();if(!e||!t||n==null)return null;const{doc:r}=t,{top:o,left:s}=e.coordsAtPos(0),{top:i,left:a}=e.coordsAtPos(n),l=r.nodeAt(n),u=n+(l?.nodeSize??0)-1,{top:c}=e.coordsAtPos(n+1),{top:d,bottom:f,right:h}=e.coordsAtPos(u),m=(c>=d?h:e.dom.getBoundingClientRect().right)-a,M=f-i+4;return g.jsx(xe.div,{style:{top:i-o,left:a-s,height:M,width:m},className:J("absolute after:absolute after:inset-x-[-4px] after:inset-y-0 after:z-0 after:rounded-md after:bg-[Highlight] after:content-[''] dark:after:bg-[Highlight]",Bn.blockCommentHover),initial:{opacity:0},animate:{opacity:1},exit:{opacity:0}})},Aa=({pos:n})=>g.jsx(je,{children:n!=null&&g.jsx(Ra,{pos:n})}),Ia={type:"spring",bounce:.12,duration:.64},rt=24,Oa=16,Da=0,_a=8,ul=({comments:n,diff:e,readonlyReason:t,isDisabled:r=!1,isRewriting:o=!1,isAnimatingFromPreview:s=!1,isSendDisabled:i=!1,previousComments:a,previousValue:l,isPreview:u=!1,isRequestActive:c=!1,isWaitingForCommentResponse:d=!1,targetedContent:f=null,onAcceleratorsExpandedChange:h,getStableCommentId:p=Po,onBlur:m,onCancelRequest:M,onChange:x,onSave:y,onAddComment:N,onSubmitAccelerator:E,onAcceptComment:T,onDismissComment:A,onExitShowChanges:S,value:R,commentsMode:P=Je.ENABLED,hideAccelerators:D=!1,hideToolbar:v=!1,hideEditOverlay:w=!1,safeUrls:b,width:V,modelCursor:H,shouldResetSelection:L,metadata:K})=>{const _=k.useRef(null),j=k.useRef(null);wa(j,_);const[{width:$},I]=Hn(),U=So(),Q=k.useRef(null),[ie,ue]=k.useState(!1),Ee=Q.current,Ae=$r(Ee)??!1,Ie=U?Io:Oo,Me=(()=>{if(V==null){const z=Ae?0:Bt();return $-z}return V-Ie*2-Bt()})(),we=Me>=Ft+Do?Ft:_o,C=Me-we,O=De(({commentingOn:z})=>z),G=De(({hoveredCommentId:z})=>z),X=De(({focusedCommentId:z})=>z),Oe=De(({hoveredBlockCommentLauncherPos:z})=>z),Xe=wn(z=>z.hoveredEditId),pr=wn(z=>z.rejectedEdits);k.useEffect(()=>{f==null&&_.current?.revertChanges()},[f]),k.useEffect(()=>{_.current?.flushChanges(),_.current?.UNSAFE_setValue(R)},[R]);const fr=it.useState(({windowHeight:z})=>{if(U)return u?Da:Oa;if(u)return rt;const Ye=_a/100*z;return Math.max(rt,Ye)}),hr=({currentTarget:z,nativeEvent:Ye})=>{const Rt=Ye.composedPath();for(const Ze of Rt.slice(0,Rt.indexOf(z)))if(Ze instanceof HTMLElement&&(Ze.id===ge.PROSEMIRROR_EDITOR_CONTAINER||Ze.id===ge.PROSEMIRROR_CONTEXT_CHILDREN))return;S?.()},Pt=u?"1rem":"max(3rem,24vh)";return g.jsx("div",{className:"h-full w-full",ref:j,onClick:hr,children:g.jsx(xe.div,{className:Ao.document,style:{margin:`0 ${Ie}px`},initial:s?{paddingTop:rt}:!1,animate:{paddingTop:fr},transition:Ia,children:g.jsx("div",{ref:Ct(I,Q),className:"z-0 flex w-full flex-col items-center",children:g.jsxs(ve,{comments:n,diff:e,editorRef:_,hoveredCommentId:G,focusedCommentId:X,hoveredEditId:Xe,rejectedEdits:pr,value:o&&!ie?"":R,commentingOn:O,isDisabled:r||o||ie,onBlur:m,onChange:x,onSave:y,width:we,safeUrls:b,wrapperClassName:"relative z-10 flex max-w-full h-fit",paddingBottom:Pt,modelCursor:H,shouldResetSelection:L,transparentBackground:!ie,contentRefereces:K?.contentReferences??[],children:[g.jsxs(ve.EditorChildren,{children:[g.jsx(je,{onExitComplete:()=>ue(!1),children:o&&g.jsx(Ea,{isRewriting:o,documentWidth:we,previousValue:l,previousComments:a,value:R,paddingBottom:Pt,onStart:()=>ue(!0)})}),!v&&g.jsx(Sa,{availableWidth:Me,isWaitingForCommentResponse:d,isSendDisabled:i,onAddComment:N,onSubmitAccelerator:E}),P===Je.ENABLED&&g.jsx(Aa,{pos:Oe}),g.jsx(je,{children:P!==Je.ALL_HIDDEN&&g.jsx(Ur,{availableWidth:C,comments:n,commentsMode:P,isRequestActive:c,onAddComment:N,onAcceptComment:T,onDismissComment:A,isWaitingForCommentResponse:d,disableBlockComments:c,getStableCommentId:p})})]}),g.jsxs(ve.ContextChildren,{children:[!w&&e&&g.jsx(Pa,{diff:e}),!D&&g.jsx(oo,{isRequestActive:c,onSubmit:E,isVisuallyHidden:i||!!t?.isStreamingFromNative||t?.isReadonly&&!t.isStreaming,actions:so,onCancel:M,onExpandedChange:h})]})]})})})})};export{ul as DocumentComposer};
//# sourceMappingURL=bv7aicfzq0qt4dog.js.map
