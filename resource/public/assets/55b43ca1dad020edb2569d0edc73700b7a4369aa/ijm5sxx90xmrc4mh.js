import{j as e,r as o,c as q,e as Y,ad as z,M as G}from"./i8w88cc8b3gds516.js";import{dV as K,dW as X,fL as Z,fM as $,a1 as ee,cv as v,di as se,fN as te,fO as ae,fP as ne,dR as oe,dS as ie,dT as re,dU as T,cu as y,ag as ce,fQ as ue,fR as C}from"./jg63sxiyqeyvfv9f.js";import{J as _,a as le,S as me,c as b,d as de}from"./fqvmdqxedgfcj4co.js";import{J as fe,S as ge}from"./l9qnx9gxiveduhi4.js";import{an as S,y as H,gi as L,q as U,l as he,D as xe}from"./eh26o1l35t2fnjj4.js";import{g as pe,a as je}from"./j36zxu0jsrspjc86.js";function be({icon:s,children:t,isOpen:a,setIsOpen:n}){return e.jsx(ne,{className:"p-0",alignAgainstAnchor:"start",triggerButton:e.jsx("button",{className:S("flex h-[34px] w-[34px] items-center justify-center rounded-lg hover:bg-token-main-surface-secondary",a&&"bg-token-main-surface-secondary"),children:s}),open:a,onOpenChange:n,children:t})}function w({label:s,icon:t,disabled:a=!1,onClick:n}){return e.jsxs("button",{className:"flex w-full items-center gap-2 rounded p-2 hover:bg-token-main-surface-secondary",disabled:a,onClick:n,children:[e.jsx("div",{className:"flex h-7 w-7 items-center justify-center",children:t}),e.jsx("div",{className:"text-sm",children:s})]})}function Ne(){return e.jsx(W,{children:e.jsx(B,{children:e.jsxs("div",{className:"my-2 flex flex-col justify-center",children:[e.jsx("div",{className:"loading-results-shimmer h-2 w-1/2 rounded-full bg-token-main-surface-secondary"}),e.jsx("div",{className:"loading-results-shimmer mt-3 h-2 w-2/5 rounded-full bg-token-main-surface-secondary"})]})})})}function W({children:s}){return e.jsx("div",{className:S("relative inline-block min-w-[360px] max-w-[400px] overflow-hidden rounded-2xl border border-token-border-light shadow-[0_2px_16px_0_rgba(0,0,0,0.04)]"),children:s})}function B({children:s}){return e.jsx("div",{className:"h-full w-full py-4 pl-5 pr-3",children:s})}function we({automation:s}){return s?e.jsx(ve,{item:s}):null}function ve({item:s}){const t=H();o.useEffect(()=>{K.count(X.JAWBONE,"jawbone_message_attachment.open")},[]);const{id:a,is_enabled:n,title:g}=s,[m,i]=o.useState(!1),u=o.useRef(null);o.useEffect(()=>{if(u.current){const c=u.current.clientHeight,p=parseFloat(getComputedStyle(u.current).lineHeight);i(c>p)}},[g]);const l=s.next_run_times.length===0,[d,f]=o.useState(!1);return e.jsxs(e.Fragment,{children:[e.jsxs(W,{children:[e.jsx("button",{className:"h-full w-full hover:bg-token-main-surface-secondary",onClick:()=>f(!0),children:e.jsx(B,{children:e.jsx("div",{className:S("flex cursor-pointer justify-between",m?"items-start":"items-center"),children:e.jsxs("div",{className:"flex flex-col gap-[2px] pr-24 text-sm",children:[e.jsx("div",{ref:u,className:"line-clamp-2 text-left font-medium",children:g}),e.jsx("div",{className:"text-left text-token-text-secondary",children:e.jsx(_,{initialScheduleComponents:s.schedule_components,nextRunTimes:s.next_run_times,children:e.jsx(fe,{item:s})})})]})})})}),e.jsx("div",{className:"absolute right-3 top-1/2 -translate-y-1/2 transform",children:e.jsx("div",{className:"ml-4 flex",children:e.jsx(Se,{automation_id:a,is_enabled:n,item:s,isFinished:l,onEditModalOpen:()=>f(!0)})})})]}),d&&e.jsx(_,{initialScheduleComponents:s.schedule_components,nextRunTimes:s.next_run_times,children:e.jsx(le,{item:s,onClose:c=>{c&&t.success(c),f(!1)}})})]})}function Se({automation_id:s,is_enabled:t,item:a,isFinished:n,onEditModalOpen:g}){const m=q(),i=Y(),u=H(),[l,d]=o.useState(t);o.useEffect(()=>d(t),[t]);const{mutate:f,isPending:c}=Z({automation_id:s,onError:r=>{u.danger(m.formatMessage(r?b.messages.enableFailure:b.messages.pauseFailure)),d(!r)}}),[p,x]=o.useState(!1),[M,N]=o.useState(!1);return e.jsxs(be,{icon:e.jsx($,{className:"icon-md"}),isOpen:M,setIsOpen:N,children:[e.jsxs("div",{className:"m-2",children:[!n&&e.jsxs(e.Fragment,{children:[e.jsx(w,{icon:e.jsx(ee,{className:"icon-md"}),label:m.formatMessage(v.attachmentEdit),onClick:g}),e.jsx(w,{icon:l?e.jsx(me,{className:"icon-md"}):e.jsx(ge,{className:"icon-md"}),label:m.formatMessage(l?b.messages.pause:b.messages.resume),onClick:()=>{const r=!l;d(r),f({is_enabled:r}),N(!1)},disabled:c})]}),n&&e.jsx(w,{icon:e.jsx(se,{className:"icon-md"}),label:m.formatMessage(b.messages.delete),onClick:()=>{x(!0)}})]}),e.jsx("hr",{className:"w-full border-token-border-light"}),e.jsx("div",{className:"m-2",children:e.jsx(w,{icon:e.jsx(te,{className:"icon-md"}),label:m.formatMessage(v.attachmentViewAll),onClick:()=>{i(ae())}})}),p&&e.jsx(de,{item:a,onClose:()=>x(!1),onConfirm:()=>x(!1)})]})}function Me({highlightedText:s,shouldShimmer:t,className:a}){return e.jsx(z,{children:e.jsx("div",{className:S(t&&"loading-shimmer-pure-text","absolute left-0 top-0 flex h-8 gap-1 overflow-hidden",a),children:e.jsx("span",{children:s})})})}const O="Too many active automations";function Ce({clientThreadId:s,currentGroupedMessage:t,nextMessage:a,isLastMessage:n,isRequestActive:g}){const m=n||a,i=g&&!a,u=o.useRef(i);o.useEffect(()=>{i&&(u.current=i)},[i]);const l=t,d=o.useMemo(()=>{for(const h of l?.messages||[]){const j=L(h.message.author.name);if(j?.namespace===U.DE1D73E)return j}},[l]),f=Ee(l,i),c=f?.automationId??"",p=f?.updatedAt??"0",x=f?.error,[M,N]=o.useState(!0),r=oe(h=>ie.getAutomation(c,h)),P=r?.updated_at??"0";o.useEffect(()=>{const h=c&&!r,j=new Date(P),V=new Date(p),Q=!!r&&j<V;(h||Q)&&re.getAutomation(c).then(A=>{T.setAutomation(c,A)}).catch(A=>{A.status===404&&N(!1)})},[r,c,P,p]);const E=l.messages,R=E[E.length-1]?.message?.metadata?.permissions,J=o.useMemo(()=>R?.some(h=>h.type==="notification"&&h.status==="requested"),[R]);o.useEffect(()=>{x===O&&u.current&&T.setMaxBannerClientThreadId(s)},[x,s]),o.useEffect(()=>{y.initIfNeeded()},[]);const k=E[0].message.create_time,D=o.useRef(!1),I=Pe();if(o.useEffect(()=>{(async()=>{if(!I){y.clearNotificationRequest();return}if(D.current)return;await ye(r,J,k)&&(D.current=!0,y.setRequestingClientThreadId(s))})()},[r,k,s,J,I]),!i&&x&&x!==O)return e.jsx(Ae,{errorUserMessage:f?.errorUserMessage});if(M&&m){if(c)return e.jsx("div",{className:"mb-3",children:r?e.jsx(we,{automation:r}):u.current?e.jsx(F,{functionName:d?.functionName}):e.jsx(Ne,{})});if(i&&d)return e.jsx(F,{functionName:d.functionName})}return null}function F({functionName:s}){const t=q();return e.jsx("div",{className:"relative h-8 text-token-text-secondary first:mt-0",children:e.jsx(Me,{highlightedText:t.formatMessage(s==="update"?v.updatingAutomation:v.makingAutomation),className:"mr-1.5 mt-1 items-center justify-start",shouldShimmer:!0})})}function Ee(s,t){return o.useMemo(()=>{if(t)return;const a=s?.messages?.find(n=>L(n.message.author.name)?.namespace===U.DE1D73E);if(a)try{const n=JSON.parse(he(a.message));return n.status==="ERROR"?{error:n.message,errorUserMessage:n.user_message}:{automationId:n.jawbone.id,updatedAt:n.jawbone.updated_at}}catch(n){xe.addError("Jawbone: Failed to parse automation message",{cause:n});return}},[s,t])}function Ae({errorUserMessage:s}){return e.jsxs("div",{className:"flex items-center gap-2 pb-1 text-token-text-error",children:[e.jsx(ce,{className:"icon-sidebar"}),e.jsx("div",{children:s??e.jsx(G,{id:"oOQhkY",defaultMessage:"Task scheduling wasn’t completed — please ask again."})})]})}async function ye(s,t,a){if(!s||!t||!a)return!1;const n=new Date(a*1e3);if(!(Math.abs(new Date().getTime()-n.getTime())<=5*60*1e3))return!1;const i=C.getLastRequestTime();return!(i&&Date.now()-new Date(i).getTime()<24*60*60*1e3||C.getPermission()==="denied"||!await pe()||await je())}function Pe(){const{data:s}=ue({alwaysRefetchOnMount:!1});return s?.some(t=>t.category==="tasks"&&t.options.some(a=>a.channel==="push"&&a.enabled))}export{Ce as JawboneMessage};
//# sourceMappingURL=ijm5sxx90xmrc4mh.js.map
